<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster Pro - Admin Panel v15 ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBY_QE1TeFyh0-zejlbEuHS3E3K0TquI4Y",
            authDomain: "quizmaster-pro-ff3a2.firebaseapp.com",
            databaseURL: "https://quizmaster-pro-ff3a2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quizmaster-pro-ff3a2",
            storageBucket: "quizmaster-pro-ff3a2.firebasestorage.app",
            messagingSenderId: "290206514077",
            appId: "1:290206514077:web:aabfd60346f1bd9c6a4d74"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        console.log('üî• Firebase initialized successfully');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Nunito', sans-serif; }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-live { background: linear-gradient(135deg, #10b981, #059669); }
        .status-assignment { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-exam { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-draft { background: linear-gradient(135deg, #6b7280, #4b5563); }

        .nav-item.active {
            background-color: #3b82f6;
            color: white;
        }

        .modal-overlay {
            backdrop-filter: blur(4px);
        }

        .game-code {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .player-item {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .question-item {
            transition: all 0.3s ease;
        }

        .question-item:hover {
            background-color: #f9fafb;
        }

        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-600 to-purple-700">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üë®‚Äçüíº</div>
                <h2 class="text-3xl font-bold text-gray-800">Admin Panel v15</h2>
                <p class="text-gray-600 mt-2">QuizMaster Pro - Sistem Manajemen Quiz</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="adminUsername" placeholder="Masukkan username admin" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="adminPassword" placeholder="Masukkan password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent" onkeypress="if(event.key==='Enter') adminLogin()">
                </div>
                
                <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all">
                    üîê Masuk Admin
                </button>
                
                <div class="text-center text-sm text-gray-500">
                    Demo: admin / admin123
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="adminPanel" class="min-h-screen bg-gray-50 hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <h1 class="text-xl font-bold text-gray-900">üéØ QuizMaster Pro Admin v15</h1>
                        <div class="hidden md:flex space-x-1">
                            <button onclick="showSection('dashboard')" class="nav-item px-4 py-2 text-sm font-medium rounded-lg active">Dashboard</button>
                            <button onclick="showSection('games')" class="nav-item px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Games</button>
                            <button onclick="showSection('questions')" class="nav-item px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Bank Soal</button>
                            <button onclick="showSection('students')" class="nav-item px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Siswa</button>
                            <button onclick="showSection('reports')" class="nav-item px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Laporan</button>
                            <button onclick="showSection('settings')" class="nav-item px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Pengaturan</button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button onclick="toggleNotifications()" class="text-gray-500 hover:text-gray-700 relative">
                                üîî
                                <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                            </button>
                            <div id="notificationDropdown" class="notification-dropdown hidden">
                                <div class="p-4 border-b">
                                    <h3 class="font-semibold text-gray-900">Notifikasi</h3>
                                </div>
                                <div id="notificationList" class="p-2">
                                    <!-- Notifications will be populated here -->
                                </div>
                            </div>
                        </div>
                        <span class="text-sm text-gray-600" id="adminInfo">Admin</span>
                        <button onclick="adminLogout()" class="text-gray-500 hover:text-gray-700">Keluar</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard Admin</h2>
                <p class="text-gray-600">Ringkasan aktivitas sistem QuizMaster Pro v15</p>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üéÆ</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Games</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalGames">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üë•</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Siswa</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalStudents">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìù</div>
                        <div>
                            <p class="text-sm text-gray-600">Bank Soal</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalQuestions">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üèÉ‚Äç‚ôÇÔ∏è</div>
                        <div>
                            <p class="text-sm text-gray-600">Games Aktif</p>
                            <p class="text-2xl font-bold text-green-600" id="activeGames">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activities & Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Recent Activities -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                    <div id="recentActivities" class="space-y-3">
                        <!-- Activities will be populated here -->
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Aksi Cepat</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="showCreateGameModal()" class="p-4 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-colors text-center">
                            <div class="text-2xl mb-2">‚ûï</div>
                            <div class="text-sm font-medium">Buat Game Baru</div>
                        </button>
                        
                        <button onclick="showSection('questions')" class="p-4 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-center">
                            <div class="text-2xl mb-2">üìù</div>
                            <div class="text-sm font-medium">Tambah Soal</div>
                        </button>
                        
                        <button onclick="showSection('students')" class="p-4 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-colors text-center">
                            <div class="text-2xl mb-2">üë•</div>
                            <div class="text-sm font-medium">Kelola Siswa</div>
                        </button>
                        
                        <button onclick="showSection('reports')" class="p-4 bg-orange-50 text-orange-700 rounded-lg hover:bg-orange-100 transition-colors text-center">
                            <div class="text-2xl mb-2">üìä</div>
                            <div class="text-sm font-medium">Lihat Laporan</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Games Section -->
        <div id="gamesSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Manajemen Games</h2>
                    <p class="text-gray-600">Kelola quiz, tugas, dan ujian</p>
                </div>
                <button onclick="showCreateGameModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors">
                    ‚ûï Buat Game Baru
                </button>
            </div>
            
            <!-- Game Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex flex-wrap gap-4">
                    <select id="gameFilterMode" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Mode</option>
                        <option value="live">Live Quiz</option>
                        <option value="assignment">Tugas/PR</option>
                        <option value="exam">Ujian</option>
                    </select>
                    
                    <select id="gameFilterStatus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Status</option>
                        <option value="active">Aktif</option>
                        <option value="completed">Selesai</option>
                        <option value="draft">Draft</option>
                    </select>
                    
                    <input type="text" id="gameSearchInput" placeholder="Cari game..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 flex-1 min-w-0">
                    
                    <button onclick="filterGames()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        üîç Filter
                    </button>
                </div>
            </div>
            
            <!-- Games List -->
            <div id="gamesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Games will be populated here -->
            </div>
        </div>

        <!-- Questions Section -->
        <div id="questionsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Bank Soal</h2>
                    <p class="text-gray-600">Kelola koleksi soal quiz</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="showImportQuestionsModal()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors">
                        üì• Import Soal
                    </button>
                    <button onclick="showCreateQuestionModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors">
                        ‚ûï Tambah Soal
                    </button>
                </div>
            </div>
            
            <!-- Question Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex flex-wrap gap-4">
                    <select id="questionFilterSubject" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Mata Pelajaran</option>
                        <option value="Matematika">Matematika</option>
                        <option value="IPA">IPA</option>
                        <option value="IPS">IPS</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                    </select>
                    
                    <select id="questionFilterDifficulty" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Tingkat</option>
                        <option value="easy">Mudah</option>
                        <option value="medium">Sedang</option>
                        <option value="hard">Sulit</option>
                    </select>
                    
                    <input type="text" id="questionSearchInput" placeholder="Cari soal..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 flex-1 min-w-0">
                    
                    <button onclick="filterQuestions()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        üîç Filter
                    </button>
                </div>
            </div>
            
            <!-- Questions List -->
            <div class="bg-white rounded-xl shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Soal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tingkat</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dibuat</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Questions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Students Section -->
        <div id="studentsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Manajemen Siswa</h2>
                    <p class="text-gray-600">Kelola data siswa dan kelas</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="showImportStudentsModal()" class="bg-green-600 text-white px-6 py-3 rounded-xl hover:bg-green-700 transition-colors">
                        üì• Import Siswa
                    </button>
                    <button onclick="showCreateStudentModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors">
                        ‚ûï Tambah Siswa
                    </button>
                </div>
            </div>
            
            <!-- Student Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="flex flex-wrap gap-4">
                    <select id="studentFilterClass" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="">Semua Kelas</option>
                        <option value="7A">7A</option>
                        <option value="7B">7B</option>
                        <option value="8A">8A</option>
                        <option value="8B">8B</option>
                        <option value="9A">9A</option>
                        <option value="9B">9B</option>
                    </select>
                    
                    <input type="text" id="studentSearchInput" placeholder="Cari siswa..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 flex-1 min-w-0">
                    
                    <button onclick="filterStudents()" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        üîç Filter
                    </button>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="bg-white rounded-xl shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Students will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reportsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Laporan & Analitik</h2>
                <p class="text-gray-600">Analisis performa dan statistik sistem</p>
            </div>
            
            <!-- Report Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üìä Laporan Nilai</h3>
                    <p class="text-gray-600 text-sm mb-4">Analisis nilai siswa per mata pelajaran</p>
                    <button onclick="generateGradeReport()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        Generate Laporan
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà Laporan Aktivitas</h3>
                    <p class="text-gray-600 text-sm mb-4">Statistik penggunaan sistem</p>
                    <button onclick="generateActivityReport()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        Generate Laporan
                    </button>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">üéØ Laporan Soal</h3>
                    <p class="text-gray-600 text-sm mb-4">Analisis tingkat kesulitan soal</p>
                    <button onclick="generateQuestionReport()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                        Generate Laporan
                    </button>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Distribusi Nilai</h3>
                    <div class="chart-container" id="gradeChart">
                        <canvas id="gradeChartCanvas" width="400" height="300"></canvas>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Harian</h3>
                    <div class="chart-container" id="activityChart">
                        <canvas id="activityChartCanvas" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Pengaturan Sistem</h2>
                <p class="text-gray-600">Konfigurasi sistem QuizMaster Pro</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- General Settings -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Umum</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Sekolah</label>
                            <input type="text" id="schoolName" value="SMP Negeri 1 Jakarta" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tahun Ajaran</label>
                            <input type="text" id="academicYear" value="2024/2025" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                            <select id="semester" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Settings -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Quiz</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Waktu Default (menit)</label>
                            <input type="number" id="defaultTime" value="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batas Peringatan Ujian</label>
                            <input type="number" id="examWarningLimit" value="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="autoSubmit" checked class="mr-2">
                            <label for="autoSubmit" class="text-sm text-gray-700">Auto-submit saat waktu habis</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="showCorrectAnswers" class="mr-2">
                            <label for="showCorrectAnswers" class="text-sm text-gray-700">Tampilkan jawaban benar setelah quiz</label>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Keamanan</h3>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="enableFullscreen" checked class="mr-2">
                            <label for="enableFullscreen" class="text-sm text-gray-700">Paksa fullscreen untuk ujian</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="blockTabSwitch" checked class="mr-2">
                            <label for="blockTabSwitch" class="text-sm text-gray-700">Blokir perpindahan tab saat ujian</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="recordViolations" checked class="mr-2">
                            <label for="recordViolations" class="text-sm text-gray-700">Catat pelanggaran ujian</label>
                        </div>
                    </div>
                </div>
                
                <!-- Backup & Export -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Backup & Export</h3>
                    <div class="space-y-4">
                        <button onclick="exportData()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                            üì• Export Data
                        </button>
                        
                        <button onclick="importData()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            üì§ Import Data
                        </button>
                        
                        <button onclick="backupDatabase()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                            üíæ Backup Database
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Save Settings -->
            <div class="mt-8 text-center">
                <button onclick="saveSettings()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl hover:bg-indigo-700 transition-colors">
                    üíæ Simpan Pengaturan
                </button>
            </div>
        </div>
    </div>

    <!-- Create Game Modal -->
    <div id="createGameModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Buat Game Baru</h3>
                    <button onclick="hideCreateGameModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Game Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Judul Quiz</label>
                        <input type="text" id="gameTitle" placeholder="Masukkan judul quiz" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mode Game</label>
                        <select id="gameMode" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="toggleGameModeSettings()">
                            <option value="live">Live Quiz</option>
                            <option value="assignment">Tugas/PR</option>
                            <option value="exam">Ujian</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="gameSubject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="Matematika">Matematika</option>
                            <option value="IPA">IPA</option>
                            <option value="IPS">IPS</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                        <select id="gameClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="All">Semua Kelas</option>
                            <option value="7A">7A</option>
                            <option value="7B">7B</option>
                            <option value="8A">8A</option>
                            <option value="8B">8B</option>
                            <option value="9A">9A</option>
                            <option value="9B">9B</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Materi</label>
                    <input type="text" id="gameMaterial" placeholder="Contoh: Aljabar, Sistem Persamaan Linear" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <!-- Game Settings -->
                <div id="gameSettings" class="border-t pt-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Pengaturan Game</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Durasi (menit)</label>
                            <input type="number" id="gameDuration" value="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div id="timeLimitContainer">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Waktu per Soal (detik)</label>
                            <input type="number" id="gameTimeLimit" value="30" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <!-- Assignment/Exam specific settings -->
                    <div id="assignmentSettings" class="mt-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deadline</label>
                            <input type="datetime-local" id="gameDeadline" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div id="examSettings" class="mt-4 hidden">
                        <div class="space-y-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="examFullscreen" checked class="mr-2">
                                <label for="examFullscreen" class="text-sm text-gray-700">Paksa Fullscreen</label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" id="examBlockTabs" checked class="mr-2">
                                <label for="examBlockTabs" class="text-sm text-gray-700">Blokir Perpindahan Tab</label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Batas Peringatan</label>
                                <input type="number" id="examWarningLimitModal" value="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Selection -->
                <div class="border-t pt-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Pilih Soal</h4>
                    <div class="max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-4">
                        <div id="questionSelection">
                            <!-- Questions will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                <button onclick="hideCreateGameModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button onclick="createGame()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Buat Game
                </button>
            </div>
        </div>
    </div>

    <!-- Create Question Modal -->
    <div id="createQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Tambah Soal Baru</h3>
                    <button onclick="hideCreateQuestionModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                        <select id="questionSubject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="Matematika">Matematika</option>
                            <option value="IPA">IPA</option>
                            <option value="IPS">IPS</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Bahasa Inggris">Bahasa Inggris</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tingkat Kesulitan</label>
                        <select id="questionDifficulty" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="easy">Mudah</option>
                            <option value="medium">Sedang</option>
                            <option value="hard">Sulit</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pertanyaan</label>
                    <textarea id="questionText" rows="3" placeholder="Masukkan pertanyaan..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pilihan Jawaban</label>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <input type="radio" name="correctAnswer" value="0" id="correct0" class="text-indigo-600">
                            <label for="correct0" class="text-sm text-gray-700">A.</label>
                            <input type="text" id="option0" placeholder="Pilihan A" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <input type="radio" name="correctAnswer" value="1" id="correct1" class="text-indigo-600">
                            <label for="correct1" class="text-sm text-gray-700">B.</label>
                            <input type="text" id="option1" placeholder="Pilihan B" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <input type="radio" name="correctAnswer" value="2" id="correct2" class="text-indigo-600">
                            <label for="correct2" class="text-sm text-gray-700">C.</label>
                            <input type="text" id="option2" placeholder="Pilihan C" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <input type="radio" name="correctAnswer" value="3" id="correct3" class="text-indigo-600">
                            <label for="correct3" class="text-sm text-gray-700">D.</label>
                            <input type="text" id="option3" placeholder="Pilihan D" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Penjelasan (Opsional)</label>
                    <textarea id="questionExplanation" rows="2" placeholder="Penjelasan jawaban yang benar..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                <button onclick="hideCreateQuestionModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button onclick="createQuestion()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Simpan Soal
                </button>
            </div>
        </div>
    </div>

    <!-- Create Student Modal -->
    <div id="createStudentModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Tambah Siswa Baru</h3>
                    <button onclick="hideCreateStudentModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
            </div>
            
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NIS</label>
                    <input type="text" id="studentNIS" placeholder="Masukkan NIS siswa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="studentName" placeholder="Masukkan nama lengkap" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                    <select id="studentClass" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <option value="7A">7A</option>
                        <option value="7B">7B</option>
                        <option value="8A">8A</option>
                        <option value="8B">8B</option>
                        <option value="9A">9A</option>
                        <option value="9B">9B</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="studentEmail" placeholder="email@school.edu" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                <button onclick="hideCreateStudentModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button onclick="createStudent()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Simpan Siswa
                </button>
            </div>
        </div>
    </div>

    <!-- Import Students Modal -->
    <div id="importStudentsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Import Data Siswa</h3>
                    <button onclick="hideImportStudentsModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload File Excel/CSV</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="studentFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="previewStudentFile(event)">
                        <div class="text-4xl mb-4">üìÅ</div>
                        <p class="text-gray-600 mb-4">Drag & drop file atau klik untuk memilih</p>
                        <button onclick="document.getElementById('studentFileInput').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Pilih File
                        </button>
                    </div>
                </div>
                
                <!-- Format Template -->
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 mb-2">üìã Format Template</h4>
                    <p class="text-blue-800 text-sm mb-3">File harus memiliki kolom berikut (urutan bebas):</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        <div class="bg-white px-3 py-1 rounded border">NIS</div>
                        <div class="bg-white px-3 py-1 rounded border">Nama</div>
                        <div class="bg-white px-3 py-1 rounded border">Kelas</div>
                        <div class="bg-white px-3 py-1 rounded border">Email</div>
                    </div>
                    <button onclick="downloadStudentTemplate()" class="mt-3 text-blue-600 hover:text-blue-800 text-sm underline">
                        üì• Download Template Excel
                    </button>
                </div>
                
                <!-- Preview -->
                <div id="importPreviewContainer" class="hidden">
                    <h4 class="font-semibold text-gray-900 mb-3">Preview Data</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="max-h-60 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">NIS</th>
                                        <th class="px-4 py-2 text-left">Nama</th>
                                        <th class="px-4 py-2 text-left">Kelas</th>
                                        <th class="px-4 py-2 text-left">Email</th>
                                        <th class="px-4 py-2 text-left">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="importPreview">
                                    <!-- Preview data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                <button onclick="hideImportStudentsModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button id="importStudentsBtn" onclick="importStudents()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    üì• Import Siswa
                </button>
            </div>
        </div>
    </div>

    <!-- Import Questions Modal -->
    <div id="importQuestionsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">Import Bank Soal</h3>
                    <button onclick="hideImportQuestionsModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload File Excel/CSV</label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="questionFileInput" accept=".xlsx,.xls,.csv" class="hidden" onchange="previewQuestionFile(event)">
                        <div class="text-4xl mb-4">üìù</div>
                        <p class="text-gray-600 mb-4">Drag & drop file atau klik untuk memilih</p>
                        <button onclick="document.getElementById('questionFileInput').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Pilih File
                        </button>
                    </div>
                </div>
                
                <!-- Format Template -->
                <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 mb-2">üìã Format Template</h4>
                    <p class="text-green-800 text-sm mb-3">File harus memiliki kolom berikut (urutan bebas):</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-3">
                        <div class="bg-white px-3 py-1 rounded border">Pertanyaan</div>
                        <div class="bg-white px-3 py-1 rounded border">Mata Pelajaran</div>
                        <div class="bg-white px-3 py-1 rounded border">Tingkat</div>
                        <div class="bg-white px-3 py-1 rounded border">Pilihan A</div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                        <div class="bg-white px-3 py-1 rounded border">Pilihan B</div>
                        <div class="bg-white px-3 py-1 rounded border">Pilihan C</div>
                        <div class="bg-white px-3 py-1 rounded border">Pilihan D</div>
                        <div class="bg-white px-3 py-1 rounded border">Jawaban Benar</div>
                    </div>
                    <p class="text-green-700 text-xs mt-2">
                        * Tingkat: easy/medium/hard | Jawaban Benar: A/B/C/D
                    </p>
                    <button onclick="downloadQuestionTemplate()" class="mt-3 text-green-600 hover:text-green-800 text-sm underline">
                        üì• Download Template Excel
                    </button>
                </div>
                
                <!-- Preview -->
                <div id="questionImportPreviewContainer" class="hidden">
                    <h4 class="font-semibold text-gray-900 mb-3">Preview Data</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="max-h-60 overflow-y-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Pertanyaan</th>
                                        <th class="px-4 py-2 text-left">Mata Pelajaran</th>
                                        <th class="px-4 py-2 text-left">Tingkat</th>
                                        <th class="px-4 py-2 text-left">Jawaban</th>
                                        <th class="px-4 py-2 text-left">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="questionImportPreview">
                                    <!-- Preview data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                <button onclick="hideImportQuestionsModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button id="importQuestionsBtn" onclick="importQuestions()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    üì• Import Soal
                </button>
            </div>
        </div>
    </div>

    <!-- Game Control Modal -->
    <div id="gameControlModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900" id="controlGameTitle">Kontrol Game</h3>
                        <p class="text-sm text-gray-600">Kode Game: <span class="game-code font-bold" id="controlGameCode">ABC123</span></p>
                    </div>
                    <button onclick="hideGameControlModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Game Status -->
                <div class="bg-gray-50 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm text-gray-600">Status Game</div>
                            <div class="text-lg font-semibold" id="gameStatus">Menunggu Pemain</div>
                        </div>
                        <div class="flex space-x-3">
                            <button id="startGameBtn" onclick="startLiveGame()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                ‚ñ∂Ô∏è Mulai Game
                            </button>
                            <button id="endGameBtn" onclick="endLiveGame()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors hidden">
                                ‚èπÔ∏è Akhiri Game
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Players List -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white border rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Pemain Bergabung (<span id="playerCount">0</span>)</h4>
                        <div id="gamePlayersList" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Players will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Live Results -->
                    <div class="bg-white border rounded-xl p-4">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Leaderboard Live</h4>
                        <div id="liveLeaderboard" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Live results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let adminState = {
            currentAdmin: null,
            games: [],
            questions: [],
            students: [],
            currentGame: null,
            gameListeners: {},
            notifications: [
                { id: 1, type: 'info', message: 'Game ABC123 telah dimulai', time: '5 menit lalu', read: false },
                { id: 2, type: 'success', message: '15 siswa bergabung ke game XYZ789', time: '10 menit lalu', read: false },
                { id: 3, type: 'warning', message: 'Soal Matematika perlu direview', time: '1 jam lalu', read: false }
            ]
        };

        // Sample admin credentials
        const adminCredentials = {
            'admin': 'admin123',
            'guru': 'guru123',
            'teacher': 'teacher123'
        };

        // Sample questions database
        const sampleQuestions = [
            {
                id: 'q1',
                subject: 'Matematika',
                difficulty: 'easy',
                question: 'Berapakah hasil dari 15 + 27?',
                options: ['40', '42', '43', '45'],
                correct: 1,
                explanation: '15 + 27 = 42',
                createdAt: '2024-01-15'
            },
            {
                id: 'q2',
                subject: 'Matematika',
                difficulty: 'medium',
                question: 'Jika x + 5 = 12, maka nilai x adalah...',
                options: ['5', '6', '7', '8'],
                correct: 2,
                explanation: 'x + 5 = 12, maka x = 12 - 5 = 7',
                createdAt: '2024-01-15'
            },
            {
                id: 'q3',
                subject: 'IPA',
                difficulty: 'easy',
                question: 'Planet terdekat dengan Matahari adalah...',
                options: ['Venus', 'Merkurius', 'Bumi', 'Mars'],
                correct: 1,
                explanation: 'Merkurius adalah planet terdekat dengan Matahari',
                createdAt: '2024-01-16'
            },
            {
                id: 'q4',
                subject: 'Bahasa Indonesia',
                difficulty: 'medium',
                question: 'Kata yang bersinonim dengan "rajin" adalah...',
                options: ['Malas', 'Giat', 'Lambat', 'Cepat'],
                correct: 1,
                explanation: 'Giat memiliki arti yang sama dengan rajin',
                createdAt: '2024-01-16'
            },
            {
                id: 'q5',
                subject: 'IPS',
                difficulty: 'easy',
                question: 'Ibu kota Indonesia adalah...',
                options: ['Surabaya', 'Bandung', 'Jakarta', 'Medan'],
                correct: 2,
                explanation: 'Jakarta adalah ibu kota negara Indonesia',
                createdAt: '2024-01-17'
            }
        ];

        // Sample students database
        const sampleStudentsData = {
            '2024001': { name: 'Ahmad Fauzi', class: '7A', email: 'ahmad.fauzi@school.edu', status: 'active' },
            '2024002': { name: 'Siti Nurhaliza', class: '7A', email: 'siti.nurhaliza@school.edu', status: 'active' },
            '2024003': { name: 'Budi Santoso', class: '7B', email: 'budi.santoso@school.edu', status: 'active' },
            '2024004': { name: 'Dewi Sartika', class: '7B', email: 'dewi.sartika@school.edu', status: 'active' },
            '2024005': { name: 'Rizki Pratama', class: '8A', email: 'rizki.pratama@school.edu', status: 'active' },
            '2024006': { name: 'Maya Indira', class: '8A', email: 'maya.indira@school.edu', status: 'active' },
            '2024007': { name: 'Andi Wijaya', class: '8B', email: 'andi.wijaya@school.edu', status: 'active' },
            '2024008': { name: 'Putri Maharani', class: '8B', email: 'putri.maharani@school.edu', status: 'active' },
            '2024009': { name: 'Fajar Nugroho', class: '9A', email: 'fajar.nugroho@school.edu', status: 'active' },
            '2024010': { name: 'Indah Permata', class: '9A', email: 'indah.permata@school.edu', status: 'active' }
        };

        // Firebase Database wrapper
        const db = {
            async init() {
                try {
                    console.log('üî• Initializing Firebase connection...');
                    return true;
                } catch (error) {
                    console.error('‚ùå Firebase connection failed:', error);
                    console.log('üì± Using offline mode');
                    return false;
                }
            },
            
            async createGame(gameData) {
                try {
                    const gameCode = generateGameCode();
                    await database.ref(`games/${gameCode}`).set({
                        ...gameData,
                        gameCode: gameCode,
                        createdAt: new Date().toISOString(),
                        status: 'draft',
                        players: [],
                        completed: false
                    });
                    return gameCode;
                } catch (error) {
                    console.error('Error creating game:', error);
                    // Simulate success for offline mode
                    return generateGameCode();
                }
            },
            
            async getGames() {
                try {
                    const snapshot = await database.ref('games').once('value');
                    const games = [];
                    if (snapshot.exists()) {
                        const gamesData = snapshot.val();
                        Object.keys(gamesData).forEach(gameCode => {
                            games.push({
                                gameCode: gameCode,
                                ...gamesData[gameCode]
                            });
                        });
                    }
                    return games;
                } catch (error) {
                    console.error('Error getting games:', error);
                    return [];
                }
            },
            
            async updateGameStatus(gameCode, status) {
                try {
                    await database.ref(`games/${gameCode}`).update({
                        status: status,
                        updatedAt: new Date().toISOString()
                    });
                    return true;
                } catch (error) {
                    console.error('Error updating game status:', error);
                    return true; // Allow offline mode
                }
            },
            
            async createQuestion(questionData) {
                try {
                    const questionId = 'q' + Date.now();
                    await database.ref(`questions/${questionId}`).set({
                        ...questionData,
                        id: questionId,
                        createdAt: new Date().toISOString()
                    });
                    return questionId;
                } catch (error) {
                    console.error('Error creating question:', error);
                    return 'q' + Date.now(); // Return ID for offline mode
                }
            },
            
            async getQuestions() {
                try {
                    const snapshot = await database.ref('questions').once('value');
                    const questions = [];
                    if (snapshot.exists()) {
                        const questionsData = snapshot.val();
                        Object.keys(questionsData).forEach(questionId => {
                            questions.push({
                                id: questionId,
                                ...questionsData[questionId]
                            });
                        });
                    }
                    // Add sample questions if empty
                    if (questions.length === 0) {
                        return sampleQuestions;
                    }
                    return questions;
                } catch (error) {
                    console.error('Error getting questions:', error);
                    return sampleQuestions;
                }
            },
            
            async updateQuestion(questionId, questionData) {
                try {
                    await database.ref(`questions/${questionId}`).update({
                        ...questionData,
                        updatedAt: new Date().toISOString()
                    });
                    return true;
                } catch (error) {
                    console.error('Error updating question:', error);
                    return true; // Allow offline mode
                }
            },
            
            async deleteQuestion(questionId) {
                try {
                    await database.ref(`questions/${questionId}`).remove();
                    return true;
                } catch (error) {
                    console.error('Error deleting question:', error);
                    return true; // Allow offline mode
                }
            },
            
            async getStudents() {
                try {
                    const snapshot = await database.ref('students').once('value');
                    const students = [];
                    if (snapshot.exists()) {
                        const studentsData = snapshot.val();
                        Object.keys(studentsData).forEach(nis => {
                            students.push({
                                nis: nis,
                                ...studentsData[nis]
                            });
                        });
                    }
                    // Add sample students if empty
                    if (students.length === 0) {
                        Object.keys(sampleStudentsData).forEach(nis => {
                            students.push({
                                nis: nis,
                                ...sampleStudentsData[nis]
                            });
                        });
                    }
                    return students;
                } catch (error) {
                    console.error('Error getting students:', error);
                    // Return sample data
                    const students = [];
                    Object.keys(sampleStudentsData).forEach(nis => {
                        students.push({
                            nis: nis,
                            ...sampleStudentsData[nis]
                        });
                    });
                    return students;
                }
            },
            
            async createStudent(studentData) {
                try {
                    await database.ref(`students/${studentData.nis}`).set({
                        ...studentData,
                        createdAt: new Date().toISOString(),
                        status: 'active'
                    });
                    return true;
                } catch (error) {
                    console.error('Error creating student:', error);
                    return true; // Allow offline mode
                }
            },
            
            async updateStudent(nis, studentData) {
                try {
                    await database.ref(`students/${nis}`).update({
                        ...studentData,
                        updatedAt: new Date().toISOString()
                    });
                    return true;
                } catch (error) {
                    console.error('Error updating student:', error);
                    return true; // Allow offline mode
                }
            },
            
            async deleteStudent(nis) {
                try {
                    await database.ref(`students/${nis}`).remove();
                    return true;
                } catch (error) {
                    console.error('Error deleting student:', error);
                    return true; // Allow offline mode
                }
            },
            
            async getGamePlayers(gameCode) {
                try {
                    const snapshot = await database.ref(`games/${gameCode}/players`).once('value');
                    if (snapshot.exists()) {
                        return snapshot.val();
                    }
                    return [];
                } catch (error) {
                    console.error('Error getting game players:', error);
                    return [];
                }
            },
            
            async getGameResults(gameCode) {
                try {
                    const snapshot = await database.ref(`grades/${gameCode}`).once('value');
                    const results = [];
                    if (snapshot.exists()) {
                        const gradesData = snapshot.val();
                        Object.keys(gradesData).forEach(nis => {
                            results.push({
                                nis: nis,
                                ...gradesData[nis]
                            });
                        });
                    }
                    return results.sort((a, b) => b.score - a.score);
                } catch (error) {
                    console.error('Error getting game results:', error);
                    return [];
                }
            }
        };

        // Utility functions
        function generateGameCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Authentication
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            
            if (!username || !password) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Tidak Lengkap!',
                    text: 'Mohon masukkan username dan password.',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }
            
            if (adminCredentials[username] && adminCredentials[username] === password) {
                adminState.currentAdmin = { username: username };
                showAdminPanel();
                
                Swal.fire({
                    icon: 'success',
                    title: `Selamat Datang, ${username}!`,
                    text: 'Login berhasil ke QuizMaster Pro v15.',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Login Gagal!',
                    text: 'Username atau password salah.',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        function adminLogout() {
            Swal.fire({
                title: 'Konfirmasi Logout',
                text: 'Yakin ingin keluar dari admin panel?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    adminState.currentAdmin = null;
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('adminPanel').classList.add('hidden');
                    
                    // Clear form
                    document.getElementById('adminUsername').value = '';
                    document.getElementById('adminPassword').value = '';
                }
            });
        }

        // Navigation
        function showAdminPanel() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            
            document.getElementById('adminInfo').textContent = `Admin: ${adminState.currentAdmin.username}`;
            showSection('dashboard');
            loadDashboardData();
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'games':
                    loadGames();
                    break;
                case 'questions':
                    loadQuestions();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Notifications
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('hidden');
            
            if (!dropdown.classList.contains('hidden')) {
                loadNotifications();
            }
        }

        function loadNotifications() {
            const container = document.getElementById('notificationList');
            container.innerHTML = '';
            
            if (adminState.notifications.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">Tidak ada notifikasi</div>';
                return;
            }
            
            adminState.notifications.forEach(notification => {
                const notifDiv = document.createElement('div');
                notifDiv.className = `p-3 hover:bg-gray-50 cursor-pointer border-b ${!notification.read ? 'bg-blue-50' : ''}`;
                notifDiv.onclick = () => markNotificationRead(notification.id);
                
                const typeIcon = notification.type === 'info' ? '‚ÑπÔ∏è' : 
                               notification.type === 'success' ? '‚úÖ' : 
                               notification.type === 'warning' ? '‚ö†Ô∏è' : 'üîî';
                
                notifDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <span class="text-lg">${typeIcon}</span>
                        <div class="flex-1">
                            <p class="text-sm text-gray-900">${notification.message}</p>
                            <p class="text-xs text-gray-500 mt-1">${notification.time}</p>
                        </div>
                        ${!notification.read ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                    </div>
                `;
                container.appendChild(notifDiv);
            });
        }

        function markNotificationRead(notificationId) {
            const notification = adminState.notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
                loadNotifications();
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadCount = adminState.notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                await db.init();
                
                // Load games
                const games = await db.getGames();
                adminState.games = games;
                document.getElementById('totalGames').textContent = games.length;
                
                const activeGames = games.filter(g => g.status === 'active').length;
                document.getElementById('activeGames').textContent = activeGames;
                
                // Load questions
                const questions = await db.getQuestions();
                adminState.questions = questions;
                document.getElementById('totalQuestions').textContent = questions.length;
                
                // Load students
                const students = await db.getStudents();
                adminState.students = students;
                document.getElementById('totalStudents').textContent = students.length;
                
                // Load recent activities
                loadRecentActivities();
                
                // Update notification badge
                updateNotificationBadge();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function loadRecentActivities() {
            const container = document.getElementById('recentActivities');
            container.innerHTML = '';
            
            // Sample recent activities
            const activities = [
                { type: 'game_created', text: 'Game "Quiz Matematika v15" dibuat', time: '2 menit lalu' },
                { type: 'student_joined', text: '5 siswa bergabung ke game ABC123', time: '5 menit lalu' },
                { type: 'question_added', text: 'Soal IPA baru ditambahkan', time: '10 menit lalu' },
                { type: 'game_completed', text: 'Game XYZ789 selesai dengan 15 peserta', time: '15 menit lalu' }
            ];
            
            activities.forEach(activity => {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                
                const icon = activity.type === 'game_created' ? 'üéÆ' : 
                           activity.type === 'student_joined' ? 'üë•' :
                           activity.type === 'question_added' ? 'üìù' : '‚úÖ';
                
                activityDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${icon}</span>
                        <div>
                            <div class="font-medium text-sm">${activity.text}</div>
                            <div class="text-xs text-gray-500">${activity.time}</div>
                        </div>
                    </div>
                `;
                container.appendChild(activityDiv);
            });
        }

        // Games Management
        async function loadGames() {
            const games = await db.getGames();
            adminState.games = games;
            displayGames(games);
        }

        function displayGames(games) {
            const container = document.getElementById('gamesList');
            container.innerHTML = '';
            
            if (games.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Belum ada game yang dibuat</div>';
                return;
            }
            
            games.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'bg-white rounded-xl shadow-sm overflow-hidden card-hover';
                
                const statusClass = game.status === 'active' ? 'status-live' : 
                                  game.status === 'completed' ? 'bg-gray-500' :
                                  game.mode === 'assignment' ? 'status-assignment' :
                                  game.mode === 'exam' ? 'status-exam' : 'status-draft';
                
                const statusText = game.status === 'active' ? 'Aktif' :
                                 game.status === 'completed' ? 'Selesai' : 'Draft';
                
                const modeText = game.mode === 'live' ? 'Live Quiz' :
                               game.mode === 'assignment' ? 'Tugas/PR' : 'Ujian';
                
                gameCard.innerHTML = `
                    <div class="${statusClass} p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">${game.mode === 'live' ? 'üéÆ' : game.mode === 'assignment' ? 'üìù' : 'üéØ'}</span>
                                <span class="font-semibold">${modeText}</span>
                            </div>
                            <span class="text-sm opacity-75">${statusText}</span>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${game.quiz?.title || 'Game Tanpa Judul'}</h3>
                        <div class="space-y-1 text-sm text-gray-600 mb-4">
                            <div>üìö ${game.subject}</div>
                            <div>üéØ ${game.material}</div>
                            <div>üë• Kelas: ${game.class}</div>
                            <div>üî¢ Kode: <span class="game-code font-bold">${game.gameCode}</span></div>
                            <div>üìù ${game.quiz?.questions?.length || 0} soal</div>
                        </div>
                        
                        <div class="flex space-x-2">
                            ${game.mode === 'live' && game.status !== 'completed' ? 
                                `<button onclick="controlGame('${game.gameCode}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                    üéÆ Kontrol
                                </button>` : ''
                            }
                            
                            <button onclick="viewGameResults('${game.gameCode}')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
                                üìä Hasil
                            </button>
                            
                            <button onclick="editGame('${game.gameCode}')" class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 transition-colors text-sm">
                                ‚úèÔ∏è Edit
                            </button>
                            
                            <button onclick="deleteGame('${game.gameCode}')" class="bg-red-600 text-white py-2 px-3 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(gameCard);
            });
        }

        function filterGames() {
            const mode = document.getElementById('gameFilterMode').value;
            const status = document.getElementById('gameFilterStatus').value;
            const search = document.getElementById('gameSearchInput').value.toLowerCase();
            
            let filteredGames = adminState.games;
            
            if (mode) {
                filteredGames = filteredGames.filter(game => game.mode === mode);
            }
            
            if (status) {
                filteredGames = filteredGames.filter(game => game.status === status);
            }
            
            if (search) {
                filteredGames = filteredGames.filter(game => 
                    game.quiz?.title?.toLowerCase().includes(search) ||
                    game.subject?.toLowerCase().includes(search) ||
                    game.gameCode?.toLowerCase().includes(search)
                );
            }
            
            displayGames(filteredGames);
        }

        // Game Creation
        function showCreateGameModal() {
            document.getElementById('createGameModal').classList.remove('hidden');
            loadQuestionSelection();
            
            // Set default deadline to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('gameDeadline').value = tomorrow.toISOString().slice(0, 16);
        }

        function hideCreateGameModal() {
            document.getElementById('createGameModal').classList.add('hidden');
            clearGameForm();
            
            // Reset modal title and button for create mode
            document.querySelector('#createGameModal h3').textContent = 'Buat Game Baru';
            const createBtn = document.querySelector('#createGameModal button[onclick*="Game"]');
            if (createBtn) {
                createBtn.textContent = 'Buat Game';
                createBtn.setAttribute('onclick', 'createGame()');
            }
        }

        function toggleGameModeSettings() {
            const mode = document.getElementById('gameMode').value;
            const timeLimitContainer = document.getElementById('timeLimitContainer');
            const assignmentSettings = document.getElementById('assignmentSettings');
            const examSettings = document.getElementById('examSettings');
            
            // Reset visibility
            timeLimitContainer.classList.remove('hidden');
            assignmentSettings.classList.add('hidden');
            examSettings.classList.add('hidden');
            
            if (mode === 'live') {
                timeLimitContainer.classList.remove('hidden');
            } else if (mode === 'assignment') {
                timeLimitContainer.classList.add('hidden');
                assignmentSettings.classList.remove('hidden');
            } else if (mode === 'exam') {
                timeLimitContainer.classList.add('hidden');
                examSettings.classList.remove('hidden');
            }
        }

        async function loadQuestionSelection() {
            const questions = await db.getQuestions();
            const container = document.getElementById('questionSelection');
            container.innerHTML = '';
            
            if (questions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Belum ada soal tersedia. Tambahkan soal terlebih dahulu.</p>';
                return;
            }
            
            questions.forEach(question => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'flex items-start space-x-3 p-3 border border-gray-200 rounded-lg mb-2';
                questionDiv.innerHTML = `
                    <input type="checkbox" id="q_${question.id}" value="${question.id}" class="mt-1">
                    <div class="flex-1">
                        <label for="q_${question.id}" class="text-sm font-medium text-gray-900 cursor-pointer">
                            ${question.question}
                        </label>
                        <div class="text-xs text-gray-500 mt-1">
                            ${question.subject} ‚Ä¢ ${question.difficulty === 'easy' ? 'Mudah' : question.difficulty === 'medium' ? 'Sedang' : 'Sulit'}
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);
            });
        }

        async function createGame() {
            const title = document.getElementById('gameTitle').value.trim();
            const mode = document.getElementById('gameMode').value;
            const subject = document.getElementById('gameSubject').value;
            const gameClass = document.getElementById('gameClass').value;
            const material = document.getElementById('gameMaterial').value.trim();
            const duration = parseInt(document.getElementById('gameDuration').value);
            
            if (!title || !material) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Tidak Lengkap!',
                    text: 'Mohon lengkapi judul dan materi quiz.',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }
            
            // Get selected questions
            const selectedQuestions = [];
            document.querySelectorAll('#questionSelection input[type="checkbox"]:checked').forEach(checkbox => {
                const questionId = checkbox.value;
                const question = adminState.questions.find(q => q.id === questionId);
                if (question) {
                    selectedQuestions.push(question);
                }
            });
            
            if (selectedQuestions.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Pilih Soal!',
                    text: 'Mohon pilih minimal 1 soal untuk quiz.',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }
            
            // Prepare game data
            const gameData = {
                mode: mode,
                subject: subject,
                class: gameClass,
                material: material,
                quiz: {
                    title: title,
                    subject: subject,
                    material: material,
                    questions: selectedQuestions
                },
                settings: {
                    duration: duration
                }
            };
            
            // Add mode-specific settings
            if (mode === 'live') {
                const timeLimit = parseInt(document.getElementById('gameTimeLimit').value);
                gameData.settings.timeLimit = timeLimit;
            } else if (mode === 'assignment') {
                const deadline = document.getElementById('gameDeadline').value;
                gameData.settings.deadline = deadline;
            } else if (mode === 'exam') {
                gameData.settings.fullscreen = document.getElementById('examFullscreen').checked;
                gameData.settings.blockTabs = document.getElementById('examBlockTabs').checked;
                gameData.settings.warningLimit = parseInt(document.getElementById('examWarningLimitModal').value);
            }
            
            try {
                Swal.fire({
                    title: 'Membuat Game...',
                    text: 'Mohon tunggu sebentar.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const gameCode = await db.createGame(gameData);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Game Berhasil Dibuat!',
                    html: `
                        <div class="text-center">
                            <p class="mb-4">Kode Game: <span class="game-code text-2xl font-bold text-blue-600">${gameCode}</span></p>
                            <p class="text-sm text-gray-600">Bagikan kode ini kepada siswa untuk bergabung</p>
                        </div>
                    `,
                    confirmButtonColor: '#10b981'
                });
                
                hideCreateGameModal();
                loadGames();
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Membuat Game!',
                    text: 'Terjadi kesalahan saat membuat game.',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        function clearGameForm() {
            document.getElementById('gameTitle').value = '';
            document.getElementById('gameMode').value = 'live';
            document.getElementById('gameSubject').value = 'Matematika';
            document.getElementById('gameClass').value = 'All';
            document.getElementById('gameMaterial').value = '';
            document.getElementById('gameDuration').value = '30';
            document.getElementById('gameTimeLimit').value = '30';
            document.getElementById('gameDeadline').value = '';
            
            // Uncheck all questions
            document.querySelectorAll('#questionSelection input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            toggleGameModeSettings();
        }

        // Game Control Functions
        async function controlGame(gameCode) {
            const game = adminState.games.find(g => g.gameCode === gameCode);
            if (!game) return;
            
            adminState.currentGame = game;
            
            // Update modal content
            document.getElementById('controlGameTitle').textContent = game.quiz?.title || 'Game Control';
            document.getElementById('controlGameCode').textContent = gameCode;
            
            // Show modal
            document.getElementById('gameControlModal').classList.remove('hidden');
            
            // Load players and setup listeners
            await loadGamePlayers(gameCode);
            setupGameListeners(gameCode);
        }

        function hideGameControlModal() {
            document.getElementById('gameControlModal').classList.add('hidden');
            
            // Clean up listeners
            if (adminState.currentGame && adminState.gameListeners[adminState.currentGame.gameCode]) {
                adminState.gameListeners[adminState.currentGame.gameCode].off();
                delete adminState.gameListeners[adminState.currentGame.gameCode];
            }
            
            adminState.currentGame = null;
        }

        async function loadGamePlayers(gameCode) {
            try {
                const players = await db.getGamePlayers(gameCode);
                const container = document.getElementById('gamePlayersList');
                const countElement = document.getElementById('playerCount');
                
                container.innerHTML = '';
                countElement.textContent = players.length;
                
                if (players.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">Belum ada pemain bergabung</div>';
                    return;
                }
                
                players.forEach((player, index) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg player-item';
                    playerDiv.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-medium text-sm">${player.name}</div>
                                <div class="text-xs text-gray-500">${player.nis}</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${new Date(player.joinedAt).toLocaleTimeString('id-ID')}
                        </div>
                    `;
                    container.appendChild(playerDiv);
                });
                
            } catch (error) {
                console.error('Error loading game players:', error);
            }
        }

        function setupGameListeners(gameCode) {
            try {
                // Listen for new players joining
                const playersRef = database.ref(`games/${gameCode}/players`);
                playersRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const players = Object.values(snapshot.val());
                        loadGamePlayers(gameCode);
                    }
                });
                
                // Listen for game results
                const resultsRef = database.ref(`grades/${gameCode}`);
                resultsRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        updateLiveLeaderboard(gameCode, snapshot.val());
                    }
                });
                
                // Store listeners for cleanup
                adminState.gameListeners[gameCode] = {
                    off: () => {
                        playersRef.off();
                        resultsRef.off();
                    }
                };
                
            } catch (error) {
                console.error('Error setting up game listeners:', error);
            }
        }

        function updateLiveLeaderboard(gameCode, gradesData) {
            const container = document.getElementById('liveLeaderboard');
            container.innerHTML = '';
            
            const results = [];
            Object.keys(gradesData).forEach(nis => {
                results.push({
                    nis: nis,
                    ...gradesData[nis]
                });
            });
            
            results.sort((a, b) => b.score - a.score);
            
            if (results.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Belum ada hasil</div>';
                return;
            }
            
            results.slice(0, 10).forEach((result, index) => {
                const student = adminState.students.find(s => s.nis === result.nis);
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                resultDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="text-lg">${rankEmoji}</div>
                        <div>
                            <div class="font-medium text-sm">${student?.name || 'Unknown'}</div>
                            <div class="text-xs text-gray-500">${result.nis}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">${result.score}</div>
                        <div class="text-xs text-gray-500">${Math.round(result.percentage)}%</div>
                    </div>
                `;
                container.appendChild(resultDiv);
            });
        }

        async function startLiveGame() {
            if (!adminState.currentGame) return;
            
            const gameCode = adminState.currentGame.gameCode;
            
            try {
                await db.updateGameStatus(gameCode, 'active');
                
                // Update UI
                document.getElementById('gameStatus').textContent = 'Game Aktif';
                document.getElementById('startGameBtn').classList.add('hidden');
                document.getElementById('endGameBtn').classList.remove('hidden');
                
                Swal.fire({
                    icon: 'success',
                    title: 'Game Dimulai!',
                    text: 'Siswa sekarang dapat mengerjakan quiz.',
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Refresh games list
                loadGames();
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Memulai Game!',
                    text: 'Terjadi kesalahan saat memulai game.',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        async function endLiveGame() {
            if (!adminState.currentGame) return;
            
            const result = await Swal.fire({
                title: 'Akhiri Game?',
                text: 'Game akan dihentikan dan siswa tidak dapat lagi mengerjakan quiz.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Akhiri',
                cancelButtonText: 'Batal'
            });
            
            if (result.isConfirmed) {
                const gameCode = adminState.currentGame.gameCode;
                
                try {
                    await db.updateGameStatus(gameCode, 'completed');
                    
                    // Update UI
                    document.getElementById('gameStatus').textContent = 'Game Selesai';
                    document.getElementById('startGameBtn').classList.remove('hidden');
                    document.getElementById('endGameBtn').classList.add('hidden');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Game Diakhiri!',
                        text: 'Game telah selesai.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Refresh games list
                    loadGames();
                    
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Mengakhiri Game!',
                        text: 'Terjadi kesalahan saat mengakhiri game.',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }

        // Game Results & Management
        async function viewGameResults(gameCode) {
            const game = adminState.games.find(g => g.gameCode === gameCode);
            if (!game) return;
            
            const results = await db.getGameResults(gameCode);
            const players = await db.getGamePlayers(gameCode);
            
            let resultsHtml = '<div class="max-h-96 overflow-y-auto">';
            
            if (results.length === 0) {
                resultsHtml += '<p class="text-center text-gray-500 py-8">Belum ada hasil tersedia</p>';
            } else {
                resultsHtml += `
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-semibold text-blue-900">üìä Statistik Game</h4>
                        <div class="grid grid-cols-2 gap-4 mt-2 text-sm">
                            <div>üë• Total Peserta: ${players.length}</div>
                            <div>‚úÖ Selesai: ${results.length}</div>
                            <div>üìà Rata-rata: ${Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length)}</div>
                            <div>üèÜ Tertinggi: ${Math.max(...results.map(r => r.score))}</div>
                        </div>
                    </div>
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left">Rank</th>
                                <th class="px-4 py-2 text-left">NIS</th>
                                <th class="px-4 py-2 text-left">Nama</th>
                                <th class="px-4 py-2 text-left">Skor</th>
                                <th class="px-4 py-2 text-left">Waktu</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                results.forEach((result, index) => {
                    const student = adminState.students.find(s => s.nis === result.nis);
                    const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}`;
                    
                    resultsHtml += `
                        <tr class="border-b">
                            <td class="px-4 py-2 font-bold">${rankEmoji}</td>
                            <td class="px-4 py-2">${result.nis}</td>
                            <td class="px-4 py-2">${student?.name || 'Unknown'}</td>
                            <td class="px-4 py-2 font-semibold text-blue-600">${result.score}</td>
                            <td class="px-4 py-2">${new Date(result.completedAt).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });
                
                resultsHtml += '</tbody></table>';
            }
            
            resultsHtml += '</div>';
            
            Swal.fire({
                title: `üìä Hasil: ${game.quiz?.title || 'Game'}`,
                html: resultsHtml,
                width: '800px',
                confirmButtonText: 'üì• Export Excel',
                showCancelButton: true,
                cancelButtonText: 'Tutup',
                confirmButtonColor: '#10b981'
            }).then((result) => {
                if (result.isConfirmed) {
                    exportGameResults(gameCode, results);
                }
            });
        }

        function exportGame<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9730c20c12f29cad',t:'MTc1NTg0ODgwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
<script>
/*
  QuizMaster Pro ‚Äì Inject Layer (Full Feature)
  -------------------------------------------------
  Drop-in script to "inject" missing features into your existing Admin Panel
  without rewriting your HTML. Works with Firebase (if already initialized) or
  falls back to localStorage. Zero external deps required; optional libs loaded
  on demand (Chart.js, SheetJS) when needed.

  How it works
  - Looks for common element IDs used by your UI (gamesList, questionsTableBody,
    studentsTableBody, etc.). If not found, degrades gracefully.
  - Exposes global API used by buttons in your HTML (createGame, createQuestion,
    createStudent, exportData, importData, backupDatabase, showSection, ...).
  - If your HTML already defines some of these functions, the inject layer will
    NOT overwrite them unless they are missing.
*/

(function () {
  const G = { // Global state
    db: null, // Firebase RTDB reference if available
    games: [],
    questions: [],
    students: [],
    charts: { grade: null, activity: null },
    loaders: { chart: false, xlsx: false },
  };

  // ---- Helpers ----
  const $ = (id) => document.getElementById(id);
  const hasEl = (id) => !!$(id);
  const byQS = (sel) => document.querySelector(sel);
  const formatDate = (d) => new Date(d).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
  function uid(prefix = '') { return (prefix || 'id') + Math.random().toString(36).slice(2, 9); }
  function gameCode() { const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r = ''; for (let i = 0; i < 6; i++) r += c[Math.floor(Math.random() * c.length)]; return r; }

  // ---- Storage adapter (Firebase if present, else localStorage) ----
  function detectFirebase() {
    try {
      if (window.firebase && firebase.apps && firebase.apps.length > 0) {
        return firebase.database();
      }
    } catch (e) { /* noop */ }
    return null;
  }
  G.db = detectFirebase();

  const store = {
    async read(path, fallback) {
      if (G.db) {
        const snap = await G.db.ref(path).once('value');
        return snap.exists() ? snap.val() : fallback;
      }
      try { return JSON.parse(localStorage.getItem(path)) ?? fallback; } catch { return fallback; }
    },
    async write(path, value) {
      if (G.db) { await G.db.ref(path).set(value); return; }
      localStorage.setItem(path, JSON.stringify(value));
    },
    async update(path, patch) {
      if (G.db) { await G.db.ref(path).update(patch); return; }
      const cur = await store.read(path, {}); await store.write(path, { ...cur, ...patch });
    },
    async remove(path) {
      if (G.db) { await G.db.ref(path).remove(); return; }
      localStorage.removeItem(path);
    },
  };

  // ---- Sample fallback (only used when storage empty) ----
  const SAMPLE = {
    questions: [
      { id: 'q1', subject: 'Matematika', difficulty: 'easy', question: '15 + 27 = ...', options: ['40', '42', '43', '45'], correct: 1, explanation: '15+27=42', createdAt: '2024-01-15' },
      { id: 'q2', subject: 'IPA', difficulty: 'easy', question: 'Planet terdekat dari Matahari?', options: ['Venus', 'Merkurius', 'Bumi', 'Mars'], correct: 1, explanation: 'Merkurius', createdAt: '2024-01-16' },
    ],
    students: [
      { nis: '2024001', name: 'Ahmad Fauzi', class: '7A', email: 'ahmad@school.edu', status: 'active' },
      { nis: '2024002', name: 'Siti Nur', class: '7A', email: 'siti@school.edu', status: 'active' },
    ],
    games: [],
  };

  // ---- Bootstrapping ----
  async function loadAll() {
    G.questions = (await store.read('questions', null)) || SAMPLE.questions;
    G.students = (await store.read('students', null)) || SAMPLE.students;
    const games = await store.read('games', null);
    G.games = games ? Object.keys(games).map(k => ({ gameCode: k, ...games[k] })) : SAMPLE.games;
  }

  async function persistAll() {
    await store.write('questions', G.questions);
    await store.write('students', G.students);
    const gamesObj = {}; G.games.forEach(g => { const code = g.gameCode || gameCode(); gamesObj[code] = { ...g, gameCode: code }; });
    await store.write('games', gamesObj);
  }

  // ---- Dynamic loader ----
  function loadScriptOnce(src) {
    return new Promise((resolve, reject) => {
      if ([...document.scripts].some(s => s.src.includes(src))) return resolve();
      const s = document.createElement('script'); s.src = src; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
    });
  }

  async function ensureChart() {
    if (window.Chart) return;
    if (!G.loaders.chart) { G.loaders.chart = true; await loadScriptOnce('https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js'); }
  }
  async function ensureXLSX() {
    if (window.XLSX) return;
    if (!G.loaders.xlsx) { G.loaders.xlsx = true; await loadScriptOnce('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'); }
  }

  // ---- Rendering (Dashboard) ----
  function renderDashboard() {
    if (hasEl('totalGames')) $('totalGames').textContent = G.games.length;
    if (hasEl('totalStudents')) $('totalStudents').textContent = G.students.length;
    if (hasEl('totalQuestions')) $('totalQuestions').textContent = G.questions.length;
    if (hasEl('activeGames')) $('activeGames').textContent = G.games.filter(g => g.status === 'active').length;
    if (hasEl('recentActivities')) {
      const wrap = $('recentActivities'); wrap.innerHTML = '';
      const recent = [
        { t: 'Sistem siap digunakan', d: new Date() },
        { t: 'Memuat data awal', d: new Date() },
      ];
      recent.forEach(r => wrap.insertAdjacentHTML('beforeend',
        `<div class="flex items-center justify-between p-3 bg-gray-50 rounded"><span class="text-sm">${r.t}</span><span class="text-xs text-gray-500">${r.d.toLocaleTimeString('id-ID')}</span></div>`
      ));
    }
  }

  // ---- Rendering (Games) ----
  function renderGames(list = G.games) {
    if (!hasEl('gamesList')) return;
    const wrap = $('gamesList'); wrap.innerHTML = '';
    if (!list.length) { wrap.innerHTML = '<div class="col-span-full text-center text-gray-500">Belum ada game.</div>'; return; }
    list.forEach(g => {
      const status = g.status || 'draft';
      const statusClass = status === 'active' ? 'bg-green-100 text-green-700' : status === 'completed' ? 'bg-gray-100 text-gray-700' : 'bg-yellow-100 text-yellow-700';
      wrap.insertAdjacentHTML('beforeend', `
        <div class="bg-white p-5 rounded-xl shadow-sm flex flex-col">
          <div class="flex items-start justify-between">
            <div>
              <h4 class="text-lg font-semibold text-gray-900">${g.title || '-'}</h4>
              <div class="text-sm text-gray-600">${g.subject || '-'} ‚Ä¢ ${g.class || 'All'} ‚Ä¢ ${g.mode || 'live'}</div>
            </div>
            <span class="text-xs px-2 py-1 rounded ${statusClass}">${status}</span>
          </div>
          <div class="mt-3 text-sm text-gray-600">Kode: <span class="font-mono font-semibold">${g.gameCode}</span></div>
          <div class="mt-4 flex items-center gap-2">
            <button class="px-3 py-2 text-sm bg-indigo-600 text-white rounded-lg" onclick="openControl('${g.gameCode}')">Kontrol</button>
            <button class="px-3 py-2 text-sm bg-gray-100 text-gray-700 rounded-lg" onclick="navigator.clipboard && navigator.clipboard.writeText('${g.gameCode}')">Copy Kode</button>
          </div>
        </div>`);
    });
  }

  function filterGames() {
    const mode = $('gameFilterMode')?.value || '';
    const status = $('gameFilterStatus')?.value || '';
    const q = ($('gameSearchInput')?.value || '').toLowerCase();
    const f = G.games.filter(g => (!mode || g.mode === mode) && (!status || g.status === status) && (!q || (g.title || '').toLowerCase().includes(q)));
    renderGames(f);
  }

  // ---- Rendering (Questions) ----
  function renderQuestions(list = G.questions) {
    if (!hasEl('questionsTableBody')) return;
    const tb = $('questionsTableBody'); tb.innerHTML = '';
    if (!list.length) { tb.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Belum ada soal.</td></tr>'; return; }
    list.forEach(q => tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="px-6 py-4 text-sm">${q.question}</td>
        <td class="px-6 py-4 text-sm text-gray-600">${q.subject}</td>
        <td class="px-6 py-4 text-sm"><span class="px-2 py-1 rounded text-xs ${q.difficulty === 'easy' ? 'bg-green-100 text-green-700' : q.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">${q.difficulty}</span></td>
        <td class="px-6 py-4 text-sm text-gray-600">${q.createdAt ? formatDate(q.createdAt) : '-'}</td>
        <td class="px-6 py-4 text-sm"><button class="px-3 py-1 bg-red-50 text-red-700 rounded" onclick="deleteQuestion('${q.id}')">Hapus</button></td>
      </tr>`));
  }

  function filterQuestions() {
    const s = $('questionFilterSubject')?.value || '';
    const d = $('questionFilterDifficulty')?.value || '';
    const q = ($('questionSearchInput')?.value || '').toLowerCase();
    const f = G.questions.filter(x => (!s || x.subject === s) && (!d || x.difficulty === d) && (!q || (x.question || '').toLowerCase().includes(q)));
    renderQuestions(f);
  }

  // ---- Rendering (Students) ----
  function renderStudents(list = G.students) {
    if (!hasEl('studentsTableBody')) return;
    const tb = $('studentsTableBody'); tb.innerHTML = '';
    if (!list.length) { tb.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Belum ada siswa.</td></tr>'; return; }
    list.forEach(s => tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td class="px-6 py-4 text-sm">${s.nis}</td>
        <td class="px-6 py-4 text-sm">${s.name}</td>
        <td class="px-6 py-4 text-sm">${s.class}</td>
        <td class="px-6 py-4 text-sm">${s.email || '-'}</td>
        <td class="px-6 py-4 text-sm">${s.status || '-'}</td>
        <td class="px-6 py-4 text-sm">
          <button class="px-3 py-1 bg-red-50 text-red-700 rounded" onclick="deleteStudent('${s.nis}')">Hapus</button>
        </td>
      </tr>`));
  }

  function filterStudents() {
    const c = $('studentFilterClass')?.value || '';
    const q = ($('studentSearchInput')?.value || '').toLowerCase();
    const f = G.students.filter(s => (!c || s.class === c) && (!q || (s.name || '').toLowerCase().includes(q) || (s.nis || '').toLowerCase().includes(q)));
    renderStudents(f);
  }

  // ---- CRUD APIs (exposed) ----
  async function createGame() {
    const title = $('gameTitle')?.value || prompt('Judul game?');
    if (!title) return;
    const code = gameCode();
    const g = {
      gameCode: code,
      title,
      subject: $('gameSubject')?.value || 'Umum',
      class: $('gameClass')?.value || 'All',
      mode: $('gameMode')?.value || 'live',
      duration: Number($('gameDuration')?.value || 30),
      timeLimit: Number($('gameTimeLimit')?.value || 30),
      deadline: $('gameDeadline')?.value || null,
      status: 'draft',
      createdAt: new Date().toISOString(),
    };
    G.games.unshift(g);
    await persistAll();
    renderGames(); renderDashboard();
    if (byQS('#createGameModal')) hideCreateGameModal?.();
    toast('Game berhasil dibuat: ' + code);
  }

  async function createQuestion() {
    const text = $('questionText')?.value || prompt('Teks pertanyaan?');
    if (!text) return;
    const subject = $('questionSubject')?.value || 'Umum';
    const difficulty = $('questionDifficulty')?.value || 'medium';
    const options = [0, 1, 2, 3].map(i => ($('option' + i)?.value || prompt(`Pilihan ${i + 1}?`) || '‚Äî'));
    const correct = Number((byQS('input[name="correctAnswer"]:checked')?.value) ?? 0);
    const q = { id: uid('q'), subject, difficulty, question: text, options, correct, explanation: $('questionExplanation')?.value || '', createdAt: new Date().toISOString() };
    G.questions.unshift(q);
    await persistAll();
    renderQuestions(); renderDashboard();
    if (byQS('#createQuestionModal')) hideCreateQuestionModal?.();
    toast('Soal ditambahkan');
  }

  async function createStudent() {
    const nis = $('studentNIS')?.value || prompt('NIS?');
    const name = $('studentName')?.value || prompt('Nama?');
    if (!nis || !name) return;
    const s = { nis, name, class: $('studentClass')?.value || prompt('Kelas?') || '7A', email: $('studentEmail')?.value || '', status: 'active', createdAt: new Date().toISOString() };
    G.students = G.students.filter(x => x.nis !== nis).concat(s);
    await persistAll();
    renderStudents(); renderDashboard();
    if (byQS('#createStudentModal')) hideCreateStudentModal?.();
    toast('Siswa disimpan');
  }

  async function deleteQuestion(id) {
    if (!confirm('Hapus soal ini?')) return;
    G.questions = G.questions.filter(q => q.id !== id);
    await persistAll();
    renderQuestions(); renderDashboard();
  }

  async function deleteStudent(nis) {
    if (!confirm('Hapus siswa ini?')) return;
    G.students = G.students.filter(s => s.nis !== nis);
    await persistAll();
    renderStudents(); renderDashboard();
  }

  // ---- Reports & Charts ----
  async function generateGradeReport() {
    await ensureChart();
    if (!hasEl('gradeChartCanvas')) return;
    const ctx = $('gradeChartCanvas').getContext('2d');
    const buckets = { '<50': 0, '50-70': 0, '70-85': 0, '>85': 0 };
    // Fake distribution based on questions count
    const n = Math.max(30, G.students.length * 2);
    for (let i = 0; i < n; i++) {
      const s = Math.floor(40 + Math.random() * 60); // 40..99
      if (s < 50) buckets['<50']++; else if (s <= 70) buckets['50-70']++; else if (s <= 85) buckets['70-85']++; else buckets['>85']++;
    }
    if (G.charts.grade) G.charts.grade.destroy();
    G.charts.grade = new Chart(ctx, {
      type: 'bar',
      data: { labels: Object.keys(buckets), datasets: [{ label: 'Jumlah Siswa', data: Object.values(buckets) }] },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });
  }

  async function generateActivityReport() {
    await ensureChart();
    if (!hasEl('activityChartCanvas')) return;
    const ctx = $('activityChartCanvas').getContext('2d');
    const labels = Array.from({ length: 7 }, (_, i) => new Date(Date.now() - (6 - i) * 86400000).toLocaleDateString('id-ID', { weekday: 'short' }));
    const values = labels.map(() => Math.floor(5 + Math.random() * 20));
    if (G.charts.activity) G.charts.activity.destroy();
    G.charts.activity = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Aktivitas', data: values }] }, options: { responsive: true } });
  }

  async function generateQuestionReport() {
    await ensureChart();
    if (!hasEl('gradeChartCanvas')) return;
    const ctx = $('gradeChartCanvas').getContext('2d');
    const counts = { easy: 0, medium: 0, hard: 0 };
    G.questions.forEach(q => counts[q.difficulty] = (counts[q.difficulty] || 0) + 1);
    if (G.charts.grade) G.charts.grade.destroy();
    G.charts.grade = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts) }] }, options: { responsive: true } });
  }

  // ---- Import/Export ----
  function dl(filename, text, mime = 'application/json') {
    const blob = new Blob([text], { type: mime }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  }

  async function exportData() {
    const payload = { games: G.games, questions: G.questions, students: G.students, exportedAt: new Date().toISOString() };
    dl('quizmaster-backup.json', JSON.stringify(payload, null, 2));
  }

  async function importData(fileOrEvent) {
    let file = null;
    if (fileOrEvent?.target?.files?.[0]) file = fileOrEvent.target.files[0];
    else if (fileOrEvent instanceof File) file = fileOrEvent;
    else {
      const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = importData; input.click(); return;
    }
    const txt = await file.text();
    const data = JSON.parse(txt);
    if (Array.isArray(data.games)) G.games = data.games; // array form
    else if (data.games && typeof data.games === 'object') G.games = Object.keys(data.games).map(k => ({ gameCode: k, ...data.games[k] }));
    G.questions = data.questions || G.questions; G.students = data.students || G.students;
    await persistAll();
    renderGames(); renderQuestions(); renderStudents(); renderDashboard();
    toast('Data berhasil di-import');
  }

  // ---- Excel/CSV Importers (Questions & Students) ----
  async function importStudents() { await ensureXLSX();
    const input = document.createElement('input'); input.type = 'file'; input.accept = '.xlsx,.xls,.csv'; input.onchange = async (e) => {
      const f = e.target.files[0]; const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws);
      rows.forEach(r => {
        const s = { nis: String(r.NIS || r.nis || r.id || uid('N')), name: r.Nama || r.nama || r.Name || 'Tanpa Nama', class: r.Kelas || r.kelas || '7A', email: r.Email || r.email || '', status: 'active' };
        G.students = G.students.filter(x => x.nis !== s.nis).concat(s);
      });
      await persistAll(); renderStudents(); renderDashboard(); toast('Import siswa selesai');
    }; input.click();
  }

  async function importQuestions() { await ensureXLSX();
    const input = document.createElement('input'); input.type = 'file'; input.accept = '.xlsx,.xls,.csv'; input.onchange = async (e) => {
      const f = e.target.files[0]; const buf = await f.arrayBuffer(); const wb = XLSX.read(buf, { type: 'array' }); const ws = wb.Sheets[wb.SheetNames[0]]; const rows = XLSX.utils.sheet_to_json(ws);
      rows.forEach(r => {
        const id = uid('q');
        const subject = r['Mata Pelajaran'] || r.subject || 'Umum';
        const difficulty = (r.Tingkat || r.difficulty || 'medium').toString().toLowerCase();
        const options = [r['Pilihan A'] || r.A || '', r['Pilihan B'] || r.B || '', r['Pilihan C'] || r.C || '', r['Pilihan D'] || r.D || ''];
        const ans = (r['Jawaban Benar'] || r.correct || 'A').toString().trim().toUpperCase();
        const correct = { A: 0, B: 1, C: 2, D: 3 }[ans] ?? 0;
        const q = { id, subject, difficulty, question: r.Pertanyaan || r.question || '‚Äî', options, correct, explanation: r.Penjelasan || '', createdAt: new Date().toISOString() };
        G.questions.unshift(q);
      });
      await persistAll(); renderQuestions(); renderDashboard(); toast('Import soal selesai');
    }; input.click();
  }

  async function downloadStudentTemplate() { await ensureXLSX(); const data = [{ NIS: '2024001', Nama: 'Nama Siswa', Kelas: '7A', Email: 'email@school.edu' }]; const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Siswa'); XLSX.writeFile(wb, 'template-siswa.xlsx'); }
  async function downloadQuestionTemplate() { await ensureXLSX(); const data = [{ Pertanyaan: 'Contoh pertanyaan', 'Mata Pelajaran': 'Matematika', Tingkat: 'easy', 'Pilihan A': 'Jawaban A', 'Pilihan B': 'Jawaban B', 'Pilihan C': 'Jawaban C', 'Pilihan D': 'Jawaban D', 'Jawaban Benar': 'A', Penjelasan: 'Opsional' }]; const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Soal'); XLSX.writeFile(wb, 'template-soal.xlsx'); }

  // ---- Backup (Firebase only) ----
  async function backupDatabase() {
    if (!G.db) { alert('Firebase tidak terdeteksi. Gunakan Export Data (JSON) sebagai alternatif.'); return; }
    const snapshot = await G.db.ref('/').once('value');
    const json = snapshot.val(); dl('firebase-backup.json', JSON.stringify(json, null, 2));
  }

  // ---- Modals (no-op safe toggles) ----
  function show(id) { const el = $(id); if (el) el.classList.remove('hidden'); }
  function hide(id) { const el = $(id); if (el) el.classList.add('hidden'); }
  function showCreateGameModal() { show('createGameModal'); populateQuestionSelection(); }
  function hideCreateGameModal() { hide('createGameModal'); }
  function showCreateQuestionModal() { show('createQuestionModal'); }
  function hideCreateQuestionModal() { hide('createQuestionModal'); }
  function showCreateStudentModal() { show('createStudentModal'); }
  function hideCreateStudentModal() { hide('createStudentModal'); }
  function showImportStudentsModal() { show('importStudentsModal'); }
  function hideImportStudentsModal() { hide('importStudentsModal'); }
  function showImportQuestionsModal() { show('importQuestionsModal'); }
  function hideImportQuestionsModal() { hide('importQuestionsModal'); }

  // ---- Question selection for game modal ----
  function populateQuestionSelection() {
    const wrap = $('questionSelection'); if (!wrap) return; wrap.innerHTML = '';
    G.questions.forEach(q => wrap.insertAdjacentHTML('beforeend', `<label class="flex items-start gap-3"><input type="checkbox" data-qid="${q.id}"><span class="text-sm">${q.question}</span></label>`));
  }

  // ---- Section navigation ----
  function showSection(key) {
    const sections = ['dashboard', 'games', 'questions', 'students', 'reports', 'settings'];
    sections.forEach(s => { const el = $(s + 'Section'); if (el) el.classList.toggle('hidden', s !== key); });
    document.querySelectorAll('.nav-item').forEach(b => { if (b.dataset.section === key) { b.classList.add('bg-blue-600', 'text-white'); b.classList.remove('text-gray-600'); } else { b.classList.remove('bg-blue-600', 'text-white'); b.classList.add('text-gray-600'); } });
    if (key === 'dashboard') renderDashboard();
    if (key === 'games') renderGames();
    if (key === 'questions') renderQuestions();
    if (key === 'students') renderStudents();
  }

  // ---- Game control (lightweight demo) ----
  function openControl(code) {
    if (!code) return alert('Game tidak ditemukan');
    $('controlGameTitle') && ($('controlGameTitle').textContent = 'Kontrol Game');
    $('controlGameCode') && ($('controlGameCode').textContent = code);
    show('gameControlModal');
  }
  function hideGameControlModal() { hide('gameControlModal'); }
  async function startLiveGame() {
    const code = $('controlGameCode')?.textContent; if (!code) return;
    G.games = G.games.map(g => g.gameCode === code ? { ...g, status: 'active' } : g);
    await persistAll(); renderGames(); renderDashboard(); toast('Game dimulai');
    $('startGameBtn') && $('startGameBtn').classList.add('hidden');
    $('endGameBtn') && $('endGameBtn').classList.remove('hidden');
    $('gameStatus') && ($('gameStatus').textContent = 'Sedang Berlangsung');
  }
  async function endLiveGame() {
    const code = $('controlGameCode')?.textContent; if (!code) return;
    G.games = G.games.map(g => g.gameCode === code ? { ...g, status: 'completed' } : g);
    await persistAll(); renderGames(); renderDashboard(); toast('Game diakhiri');
    $('startGameBtn') && $('startGameBtn').classList.remove('hidden');
    $('endGameBtn') && $('endGameBtn').classList.add('hidden');
    $('gameStatus') && ($('gameStatus').textContent = 'Selesai');
  }

  // ---- Tiny toast ----
  function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg; t.style.cssText = 'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:all .3s;z-index:9999';
    document.body.appendChild(t); requestAnimationFrame(() => { t.style.opacity = '1'; t.style.bottom = '24px'; }); setTimeout(() => { t.style.opacity = '0'; t.style.bottom = '16px'; setTimeout(() => t.remove(), 300); }, 1600);
  }

  // ---- Public API (only attach if missing to avoid overwriting) ----
  const api = {
    // CRUD + render
    renderDashboard, renderGames, renderQuestions, renderStudents,
    filterGames, filterQuestions, filterStudents,
    createGame, createQuestion, createStudent,
    deleteQuestion, deleteStudent,
    // Reports
    generateGradeReport, generateActivityReport, generateQuestionReport,
    // Import/Export
    exportData, importData, importStudents, importQuestions,
    downloadStudentTemplate, downloadQuestionTemplate,
    // Firebase backup
    backupDatabase,
    // Modals & sections
    showCreateGameModal, hideCreateGameModal,
    showCreateQuestionModal, hideCreateQuestionModal,
    showCreateStudentModal, hideCreateStudentModal,
    showImportStudentsModal, hideImportStudentsModal,
    showImportQuestionsModal, hideImportQuestionsModal,
    populateQuestionSelection,
    showSection,
    // Game control
    openControl, hideGameControlModal, startLiveGame, endLiveGame,
  };
  Object.keys(api).forEach(k => { if (!(k in window)) window[k] = api[k]; });

  // ---- Auto init ----
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await loadAll();
      renderDashboard(); renderGames(); renderQuestions(); renderStudents();
      // Bind nav items if exist
      document.querySelectorAll('.nav-item').forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.section)));
    } catch (e) { console.error('[Inject] init error', e); }
  });
})();

</script>
</html>
<script>
// --- Injected fixes ---

// Simple adminLogin() for demo purposes
function adminLogin() {
  const user = document.getElementById("username")?.value || "";
  const pass = document.getElementById("password")?.value || "";
  if (user === "admin" && pass === "admin") {
    localStorage.setItem("isAdmin", "true");
    alert("Login berhasil sebagai admin!");
    // tampilkan dashboard atau redirect jika perlu
    if (document.getElementById("dashboardSection")) {
      document.getElementById("dashboardSection").classList.remove("hidden");
    }
  } else {
    alert("Login gagal. Gunakan admin/admin untuk testing.");
  }
}

// Patch Firebase error handling to fallback silently if permission_denied
if (window.firebase && firebase.database) {
  const origRef = firebase.database().ref;
  firebase.database().ref = function(...args) {
    const r = origRef.apply(this, args);
    const origOnce = r.once;
    r.once = function(event, ...rest) {
      return origOnce.call(this, event, ...rest).catch(err => {
        console.warn("Firebase permission denied, fallback to localStorage", err);
        return { exists: () => false, val: () => null };
      });
    };
    return r;
  };
}
</script>
