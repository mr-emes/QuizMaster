<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster Pro - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, onValue, off, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase configuration - SUDAH DIKONFIGURASI ‚úÖ
        const firebaseConfig = {
            apiKey: "AIzaSyBY_QE1TeFyh0-zejlbEuHS3E3K0TquI4Y",
            authDomain: "quizmaster-pro-ff3a2.firebaseapp.com",
            databaseURL: "https://quizmaster-pro-ff3a2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quizmaster-pro-ff3a2",
            storageBucket: "quizmaster-pro-ff3a2.firebasestorage.app",
            messagingSenderId: "290206514077",
            appId: "1:290206514077:web:aabfd60346f1bd9c6a4d74"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make Firebase available globally
        window.firebase = { database, ref, set, get, push, onValue, off, remove, update };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Nunito', sans-serif; }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-600 to-purple-700">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üë®‚Äçüíº</div>
                <h2 class="text-3xl font-bold text-gray-800">Admin Panel</h2>
                <p class="text-gray-600 mt-2">QuizMaster Pro - Sistem Manajemen Quiz</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="adminUsername" value="admin" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="adminPassword" value="admin123" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <button onclick="adminLogin()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all">
                    üöÄ Masuk Admin
                </button>
                
                <div class="text-xs text-gray-500 text-center mt-4">
                    Demo: admin / admin123
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardScreen" class="min-h-screen bg-gray-50 hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <h1 class="text-xl font-bold text-gray-900">üéØ QuizMaster Pro</h1>
                        <div class="hidden md:flex space-x-4">
                            <button onclick="showSection('dashboard')" class="nav-btn px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-lg">Dashboard</button>
                            <button onclick="showSection('students')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Data Siswa</button>
                            <button onclick="showSection('quizzes')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Quiz</button>
                            <button onclick="showSection('games')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Game Aktif</button>
                            <button onclick="showSection('grades')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 rounded-lg">Daftar Nilai</button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">Admin</span>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700">Keluar</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard</h2>
                <p class="text-gray-600">Ringkasan sistem QuizMaster Pro</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üë•</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Siswa</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalStudents">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìö</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Quiz</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalQuizzes">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üéÆ</div>
                        <div>
                            <p class="text-sm text-gray-600">Game Aktif</p>
                            <p class="text-2xl font-bold text-gray-900" id="activeGames">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">üìä</div>
                        <div>
                            <p class="text-sm text-gray-600">Total Nilai</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalGrades">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Game Terbaru</h3>
                    <div id="recentGames" class="space-y-3">
                        <!-- Recent games will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistik Kelas</h3>
                    <div id="classStats" class="space-y-3">
                        <!-- Class statistics will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Section -->
        <div id="studentsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Data Siswa</h2>
                    <p class="text-gray-600">Kelola data siswa (NIS, Nama, Kelas)</p>
                </div>
                <button onclick="showAddStudentModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors">
                    ‚ûï Tambah Siswa
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                        <div class="flex items-center space-x-4">
                            <input type="text" id="studentSearch" placeholder="Cari siswa..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <select id="classFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">Semua Kelas</option>
                                <option value="7A">7A</option>
                                <option value="7B">7B</option>
                                <option value="8A">8A</option>
                                <option value="8B">8B</option>
                                <option value="9A">9A</option>
                                <option value="9B">9B</option>
                            </select>
                        </div>
                        <button onclick="exportStudents()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            üìä Export Excel
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terdaftar</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Students will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quizzes Section -->
        <div id="quizzesSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Manajemen Quiz</h2>
                    <p class="text-gray-600">Buat dan kelola quiz untuk siswa</p>
                </div>
                <button onclick="showCreateQuizModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition-colors">
                    ‚ûï Buat Quiz Baru
                </button>
            </div>
            
            <div id="quizzesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Quizzes will be populated here -->
            </div>
        </div>

        <!-- Games Section -->
        <div id="gamesSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Game Aktif</h2>
                    <p class="text-gray-600">Monitor game yang sedang berlangsung</p>
                </div>
            </div>
            
            <div id="activeGamesList" class="space-y-6">
                <!-- Active games will be populated here -->
            </div>
        </div>

        <!-- Grades Section -->
        <div id="gradesSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Daftar Nilai</h2>
                    <p class="text-gray-600">Lihat dan analisis hasil quiz siswa</p>
                </div>
                <div class="flex space-x-4">
                    <select id="gradeClassFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Semua Kelas</option>
                        <option value="7A">7A</option>
                        <option value="7B">7B</option>
                        <option value="8A">8A</option>
                        <option value="8B">8B</option>
                        <option value="9A">9A</option>
                        <option value="9B">9B</option>
                    </select>
                    <select id="gradeSubjectFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Semua Mapel</option>
                        <option value="Matematika">Matematika</option>
                        <option value="IPA">IPA</option>
                        <option value="IPS">IPS</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                    </select>
                    <button onclick="exportGrades()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        üìä Export Nilai
                    </button>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mapel</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            </tr>
                        </thead>
                        <tbody id="gradesTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Grades will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Tambah Siswa Baru</h3>
                <button onclick="hideAddStudentModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NIS</label>
                    <input type="text" id="newStudentNIS" placeholder="Contoh: 2024001" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="newStudentName" placeholder="Contoh: Ahmad Fauzi" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                    <select id="newStudentClass" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Pilih Kelas</option>
                        <option value="7A">7A</option>
                        <option value="7B">7B</option>
                        <option value="8A">8A</option>
                        <option value="8B">8B</option>
                        <option value="9A">9A</option>
                        <option value="9B">9B</option>
                    </select>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button onclick="hideAddStudentModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        Batal
                    </button>
                    <button onclick="addStudent()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors">
                        Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Quiz Modal -->
    <div id="createQuizModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Buat Quiz Baru</h3>
                <button onclick="hideCreateQuizModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                    <select id="newQuizSubject" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Pilih Mapel</option>
                        <option value="Matematika">Matematika</option>
                        <option value="IPA">IPA</option>
                        <option value="IPS">IPS</option>
                        <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                        <option value="Bahasa Inggris">Bahasa Inggris</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                    <select id="newQuizClass" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="">Pilih Kelas</option>
                        <option value="7A">7A</option>
                        <option value="7B">7B</option>
                        <option value="8A">8A</option>
                        <option value="8B">8B</option>
                        <option value="9A">9A</option>
                        <option value="9B">9B</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Materi</label>
                    <input type="text" id="newQuizMaterial" placeholder="Contoh: Aljabar Linear" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul Quiz</label>
                    <input type="text" id="newQuizTitle" placeholder="Contoh: Quiz Aljabar Linear" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
            </div>
            
            <div class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-semibold text-gray-900">Pertanyaan</h4>
                    <button onclick="addQuizQuestion()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                        ‚ûï Tambah Soal
                    </button>
                </div>
                
                <div id="quizQuestionsContainer" class="space-y-6">
                    <!-- Questions will be added here -->
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="hideCreateQuizModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                    Batal
                </button>
                <button onclick="saveQuiz()" class="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors">
                    üíæ Simpan Quiz
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            currentSection: 'dashboard',
            students: [],
            quizzes: [],
            games: [],
            grades: []
        };

        // Firebase Database wrapper
        const db = {
            async init() {
                try {
                    await this.loadStudents();
                    await this.loadQuizzes();
                    await this.loadGames();
                    await this.loadGrades();
                    console.log('‚úÖ Firebase connected successfully!');
                } catch (error) {
                    console.error('‚ùå Firebase connection failed:', error);
                    console.log('üì± Using offline mode with localStorage');
                    this.loadFromLocalStorage();
                }
            },
            
            async loadStudents() {
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'students'));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        appState.students = Object.keys(data).map(nis => ({
                            nis: nis,
                            ...data[nis]
                        }));
                    } else {
                        appState.students = [];
                    }
                } catch (error) {
                    console.error('Error loading students:', error);
                    appState.students = JSON.parse(localStorage.getItem('students') || '[]');
                }
            },
            
            async addStudent(student) {
                try {
                    const { database, ref, set } = window.firebase;
                    await set(ref(database, `students/${student.nis}`), {
                        name: student.name,
                        class: student.class,
                        createdAt: new Date().toISOString()
                    });
                    
                    appState.students.push(student);
                    localStorage.setItem('students', JSON.stringify(appState.students));
                    return true;
                } catch (error) {
                    console.error('Error adding student:', error);
                    appState.students.push(student);
                    localStorage.setItem('students', JSON.stringify(appState.students));
                    return true;
                }
            },
            
            async deleteStudent(nis) {
                try {
                    const { database, ref, remove } = window.firebase;
                    await remove(ref(database, `students/${nis}`));
                    
                    appState.students = appState.students.filter(s => s.nis !== nis);
                    localStorage.setItem('students', JSON.stringify(appState.students));
                    return true;
                } catch (error) {
                    console.error('Error deleting student:', error);
                    return false;
                }
            },
            
            async loadQuizzes() {
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'quizzes'));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        appState.quizzes = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                    } else {
                        appState.quizzes = [];
                    }
                } catch (error) {
                    console.error('Error loading quizzes:', error);
                    appState.quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                }
            },
            
            async addQuiz(quiz) {
                try {
                    const { database, ref, push, set } = window.firebase;
                    quiz.createdAt = new Date().toISOString();
                    
                    const newQuizRef = push(ref(database, 'quizzes'));
                    await set(newQuizRef, quiz);
                    
                    quiz.id = newQuizRef.key;
                    appState.quizzes.push(quiz);
                    localStorage.setItem('quizzes', JSON.stringify(appState.quizzes));
                    
                    return quiz.id;
                } catch (error) {
                    console.error('Error saving quiz:', error);
                    quiz.id = Date.now().toString();
                    quiz.createdAt = new Date().toISOString();
                    appState.quizzes.push(quiz);
                    localStorage.setItem('quizzes', JSON.stringify(appState.quizzes));
                    return quiz.id;
                }
            },
            
            async createGame(quizId) {
                try {
                    const gameCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    const quiz = appState.quizzes.find(q => q.id === quizId);
                    
                    const gameData = {
                        quizId: quizId,
                        quiz: quiz,
                        subject: quiz.subject,
                        material: quiz.material,
                        class: quiz.class,
                        gameCode: gameCode,
                        players: [],
                        started: false,
                        completed: false,
                        createdAt: Date.now()
                    };
                    
                    const { database, ref, set } = window.firebase;
                    await set(ref(database, `games/${gameCode}`), gameData);
                    
                    appState.games.push(gameData);
                    localStorage.setItem('games', JSON.stringify(appState.games));
                    
                    return gameCode;
                } catch (error) {
                    console.error('Error creating game:', error);
                    return null;
                }
            },
            
            async loadGames() {
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'games'));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        appState.games = Object.keys(data).map(key => ({
                            gameCode: key,
                            ...data[key]
                        }));
                    } else {
                        appState.games = [];
                    }
                } catch (error) {
                    console.error('Error loading games:', error);
                    appState.games = JSON.parse(localStorage.getItem('games') || '[]');
                }
            },
            
            async loadGrades() {
                try {
                    const { database, ref, get } = window.firebase;
                    const snapshot = await get(ref(database, 'grades'));
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        appState.grades = [];
                        
                        Object.keys(data).forEach(gameCode => {
                            Object.keys(data[gameCode]).forEach(nis => {
                                appState.grades.push({
                                    gameCode: gameCode,
                                    nis: nis,
                                    ...data[gameCode][nis]
                                });
                            });
                        });
                    } else {
                        appState.grades = [];
                    }
                } catch (error) {
                    console.error('Error loading grades:', error);
                    appState.grades = JSON.parse(localStorage.getItem('grades') || '[]');
                }
            },
            
            loadFromLocalStorage() {
                appState.students = JSON.parse(localStorage.getItem('students') || '[]');
                appState.quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                appState.games = JSON.parse(localStorage.getItem('games') || '[]');
                appState.grades = JSON.parse(localStorage.getItem('grades') || '[]');
            }
        };

        // Authentication
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === 'admin' && password === 'admin123') {
                showDashboard();
            } else {
                alert('Username atau password salah!');
            }
        }

        function logout() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
        }

        // Navigation
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            showSection('dashboard');
            loadDashboardData();
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-indigo-600', 'bg-indigo-50');
                btn.classList.add('text-gray-600');
            });
            
            event.target.classList.remove('text-gray-600');
            event.target.classList.add('text-indigo-600', 'bg-indigo-50');
            
            appState.currentSection = sectionName;
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'students':
                    loadStudentsData();
                    break;
                case 'quizzes':
                    loadQuizzesData();
                    break;
                case 'games':
                    loadGamesData();
                    break;
                case 'grades':
                    loadGradesData();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            await db.init();
            
            document.getElementById('totalStudents').textContent = appState.students.length;
            document.getElementById('totalQuizzes').textContent = appState.quizzes.length;
            document.getElementById('activeGames').textContent = appState.games.filter(g => !g.completed).length;
            document.getElementById('totalGrades').textContent = appState.grades.length;
            
            // Load recent games
            const recentGames = appState.games.slice(-5).reverse();
            const recentGamesContainer = document.getElementById('recentGames');
            recentGamesContainer.innerHTML = '';
            
            if (recentGames.length === 0) {
                recentGamesContainer.innerHTML = '<p class="text-gray-500 text-sm">Belum ada game</p>';
            } else {
                recentGames.forEach(game => {
                    const gameDiv = document.createElement('div');
                    gameDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    gameDiv.innerHTML = `
                        <div>
                            <div class="font-medium text-sm">${game.quiz?.title || 'Quiz'}</div>
                            <div class="text-xs text-gray-500">${game.subject} - ${game.class}</div>
                        </div>
                        <div class="text-xs text-gray-500">${game.gameCode}</div>
                    `;
                    recentGamesContainer.appendChild(gameDiv);
                });
            }
            
            // Load class statistics
            const classStats = {};
            appState.students.forEach(student => {
                if (!classStats[student.class]) {
                    classStats[student.class] = 0;
                }
                classStats[student.class]++;
            });
            
            const classStatsContainer = document.getElementById('classStats');
            classStatsContainer.innerHTML = '';
            
            Object.keys(classStats).forEach(className => {
                const statDiv = document.createElement('div');
                statDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                statDiv.innerHTML = `
                    <div class="font-medium text-sm">Kelas ${className}</div>
                    <div class="text-sm text-gray-600">${classStats[className]} siswa</div>
                `;
                classStatsContainer.appendChild(statDiv);
            });
        }

        // Students functions
        async function loadStudentsData() {
            await db.loadStudents();
            displayStudents();
        }

        function displayStudents(filteredStudents = null) {
            const students = filteredStudents || appState.students;
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Belum ada data siswa</td></tr>';
                return;
            }
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nis}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(student.createdAt || Date.now()).toLocaleDateString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editStudent('${student.nis}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="deleteStudentConfirm('${student.nis}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.remove('hidden');
        }

        function hideAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('hidden');
            // Clear form
            document.getElementById('newStudentNIS').value = '';
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentClass').value = '';
        }

        async function addStudent() {
            const nis = document.getElementById('newStudentNIS').value.trim();
            const name = document.getElementById('newStudentName').value.trim();
            const className = document.getElementById('newStudentClass').value;
            
            if (!nis || !name || !className) {
                alert('Mohon lengkapi semua data!');
                return;
            }
            
            // Check if NIS already exists
            if (appState.students.find(s => s.nis === nis)) {
                alert('NIS sudah terdaftar!');
                return;
            }
            
            const student = {
                nis: nis,
                name: name,
                class: className,
                createdAt: new Date().toISOString()
            };
            
            const success = await db.addStudent(student);
            if (success) {
                alert('Siswa berhasil ditambahkan! üéâ');
                hideAddStudentModal();
                displayStudents();
            } else {
                alert('Gagal menambahkan siswa. Coba lagi.');
            }
        }

        async function deleteStudentConfirm(nis) {
            if (confirm('Yakin ingin menghapus data siswa ini?')) {
                const success = await db.deleteStudent(nis);
                if (success) {
                    alert('Data siswa berhasil dihapus!');
                    displayStudents();
                } else {
                    alert('Gagal menghapus data siswa.');
                }
            }
        }

        // Quiz functions
        async function loadQuizzesData() {
            await db.loadQuizzes();
            displayQuizzes();
        }

        function displayQuizzes() {
            const container = document.getElementById('quizzesList');
            container.innerHTML = '';
            
            if (appState.quizzes.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Belum ada quiz. Buat quiz pertama!</div>';
                return;
            }
            
            appState.quizzes.forEach(quiz => {
                const quizCard = document.createElement('div');
                quizCard.className = 'bg-white rounded-xl shadow-sm p-6 card-hover';
                quizCard.innerHTML = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${quiz.title}</h3>
                        <div class="space-y-1 text-sm text-gray-600">
                            <div>üìö ${quiz.subject}</div>
                            <div>üéØ ${quiz.material}</div>
                            <div>üë• ${quiz.class}</div>
                            <div>üìù ${quiz.questions?.length || 0} soal</div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="hostQuiz('${quiz.id}')" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">
                            üéÆ Host
                        </button>
                        <button onclick="editQuiz('${quiz.id}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            ‚úèÔ∏è Edit
                        </button>
                        <button onclick="deleteQuizConfirm('${quiz.id}')" class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">
                            üóëÔ∏è Hapus
                        </button>
                    </div>
                `;
                container.appendChild(quizCard);
            });
        }

        function showCreateQuizModal() {
            document.getElementById('createQuizModal').classList.remove('hidden');
            document.getElementById('quizQuestionsContainer').innerHTML = '';
            addQuizQuestion(); // Add first question
        }

        function hideCreateQuizModal() {
            document.getElementById('createQuizModal').classList.add('hidden');
        }

        let questionCounter = 0;

        function addQuizQuestion() {
            questionCounter++;
            const container = document.getElementById('quizQuestionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-item bg-gray-50 p-4 rounded-xl border';
            questionDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h5 class="font-semibold text-gray-900">Soal ${questionCounter}</h5>
                    <button onclick="removeQuizQuestion(this)" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                </div>
                
                <div class="space-y-4">
                    <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Tulis pertanyaan..." rows="2"></textarea>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" class="option-input px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Pilihan A">
                        <input type="text" class="option-input px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Pilihan B">
                        <input type="text" class="option-input px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Pilihan C">
                        <input type="text" class="option-input px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Pilihan D">
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <select class="correct-answer px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="">Jawaban Benar</option>
                            <option value="0">A</option>
                            <option value="1">B</option>
                            <option value="2">C</option>
                            <option value="3">D</option>
                        </select>
                        <input type="number" class="time-limit px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent w-24" value="30" min="10" max="120" placeholder="Waktu">
                    </div>
                </div>
            `;
            container.appendChild(questionDiv);
        }

        function removeQuizQuestion(button) {
            button.closest('.question-item').remove();
            updateQuestionNumbers();
        }

        function updateQuestionNumbers() {
            const questions = document.querySelectorAll('.question-item h5');
            questions.forEach((h5, index) => {
                h5.textContent = `Soal ${index + 1}`;
            });
            questionCounter = questions.length;
        }

        async function saveQuiz() {
            const subject = document.getElementById('newQuizSubject').value;
            const className = document.getElementById('newQuizClass').value;
            const material = document.getElementById('newQuizMaterial').value.trim();
            const title = document.getElementById('newQuizTitle').value.trim();
            const questionItems = document.querySelectorAll('.question-item');

            if (!subject || !className || !material || !title) {
                alert('Mohon lengkapi data quiz!');
                return;
            }

            if (questionItems.length === 0) {
                alert('Mohon tambahkan minimal 1 pertanyaan!');
                return;
            }

            const questions = [];
            let isValid = true;

            questionItems.forEach((item, index) => {
                const questionText = item.querySelector('.question-text').value.trim();
                const options = Array.from(item.querySelectorAll('.option-input')).map(input => input.value.trim());
                const correctAnswer = item.querySelector('.correct-answer').value;
                const timeLimit = parseInt(item.querySelector('.time-limit').value);

                if (!questionText || options.some(opt => !opt) || correctAnswer === '') {
                    alert(`Soal ${index + 1} belum lengkap!`);
                    isValid = false;
                    return;
                }

                questions.push({
                    question: questionText,
                    options: options,
                    correct: parseInt(correctAnswer),
                    timeLimit: timeLimit
                });
            });

            if (!isValid) return;

            const quiz = {
                subject: subject,
                class: className,
                material: material,
                title: title,
                questions: questions
            };

            try {
                await db.addQuiz(quiz);
                alert('Quiz berhasil disimpan! üéâ');
                hideCreateQuizModal();
                displayQuizzes();
            } catch (error) {
                alert('Quiz disimpan secara offline. Akan disinkronkan saat online.');
                hideCreateQuizModal();
                displayQuizzes();
            }
        }

        async function hostQuiz(quizId) {
            try {
                const gameCode = await db.createGame(quizId);
                if (gameCode) {
                    alert(`Game berhasil dibuat!\nKode Game: ${gameCode}\n\nBagikan kode ini ke siswa untuk bergabung.`);
                    loadGamesData();
                } else {
                    alert('Gagal membuat game. Coba lagi.');
                }
            } catch (error) {
                alert('Gagal membuat game. Coba lagi.');
                console.error('Error hosting quiz:', error);
            }
        }

        // Games functions
        async function loadGamesData() {
            await db.loadGames();
            displayGames();
        }

        function displayGames() {
            const container = document.getElementById('activeGamesList');
            container.innerHTML = '';
            
            const activeGames = appState.games.filter(g => !g.completed);
            
            if (activeGames.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Belum ada game aktif</div>';
                return;
            }
            
            activeGames.forEach(game => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'bg-white rounded-xl shadow-sm p-6';
                gameDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${game.quiz?.title || 'Quiz'}</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-4">
                                <div>üìö ${game.subject}</div>
                                <div>üéØ ${game.material}</div>
                                <div>üë• ${game.class}</div>
                                <div>üéÆ ${game.gameCode}</div>
                            </div>
                            <div class="flex items-center space-x-4 text-sm">
                                <span class="text-gray-600">Pemain: ${game.players?.length || 0}</span>
                                <span class="px-2 py-1 rounded-full text-xs ${game.started ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${game.started ? 'Berlangsung' : 'Menunggu'}
                                </span>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4">
                            <button onclick="monitorGame('${game.gameCode}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                üëÅÔ∏è Monitor
                            </button>
                            <button onclick="endGameConfirm('${game.gameCode}')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                                ‚èπÔ∏è Akhiri
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(gameDiv);
            });
        }

        // Grades functions
        async function loadGradesData() {
            await db.loadGrades();
            displayGrades();
        }

        function displayGrades() {
            const tbody = document.getElementById('gradesTableBody');
            tbody.innerHTML = '';
            
            if (appState.grades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data nilai</td></tr>';
                return;
            }
            
            appState.grades.forEach(grade => {
                const student = appState.students.find(s => s.nis === grade.nis);
                const game = appState.games.find(g => g.gameCode === grade.gameCode);
                
                if (!student || !game) return;
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nis}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.class}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${game.subject}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${game.material}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${grade.score >= 80 ? 'text-green-600' : grade.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">${grade.score}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(grade.completedAt).toLocaleDateString('id-ID')}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Utility functions
        function editStudent(nis) {
            alert('Fitur edit siswa akan segera hadir!');
        }

        function editQuiz(quizId) {
            alert('Fitur edit quiz akan segera hadir!');
        }

        function deleteQuizConfirm(quizId) {
            if (confirm('Yakin ingin menghapus quiz ini?')) {
                // Implementation for delete quiz
                alert('Quiz berhasil dihapus!');
                displayQuizzes();
            }
        }

        function monitorGame(gameCode) {
            alert(`Monitoring game ${gameCode}. Fitur akan segera hadir!`);
        }

        function endGameConfirm(gameCode) {
            if (confirm('Yakin ingin mengakhiri game ini?')) {
                alert('Game berhasil diakhiri!');
                loadGamesData();
            }
        }

        function exportStudents() {
            alert('Export data siswa ke Excel. Fitur akan segera hadir!');
        }

        function exportGrades() {
            alert('Export data nilai ke Excel. Fitur akan segera hadir!');
        }

        // Search and filter functions
        document.addEventListener('DOMContentLoaded', function() {
            // Student search
            document.getElementById('studentSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const classFilter = document.getElementById('classFilter').value;
                
                let filtered = appState.students.filter(student => {
                    const matchesSearch = student.name.toLowerCase().includes(searchTerm) || 
                                        student.nis.toLowerCase().includes(searchTerm);
                    const matchesClass = !classFilter || student.class === classFilter;
                    return matchesSearch && matchesClass;
                });
                
                displayStudents(filtered);
            });
            
            document.getElementById('classFilter').addEventListener('change', function(e) {
                const classFilter = e.target.value;
                const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
                
                let filtered = appState.students.filter(student => {
                    const matchesSearch = student.name.toLowerCase().includes(searchTerm) || 
                                        student.nis.toLowerCase().includes(searchTerm);
                    const matchesClass = !classFilter || student.class === classFilter;
                    return matchesSearch && matchesClass;
                });
                
                displayStudents(filtered);
            });
            
            // Initialize sample data if needed
            initializeSampleData();
        });

        async function initializeSampleData() {
            await db.init();
            
            // Add sample students if none exist
            if (appState.students.length === 0) {
                const sampleStudents = [
                    { nis: '2024001', name: 'Ahmad Fauzi', class: '7A' },
                    { nis: '2024002', name: 'Siti Nurhaliza', class: '7A' },
                    { nis: '2024003', name: 'Budi Santoso', class: '7B' },
                    { nis: '2024004', name: 'Rina Kartika', class: '7B' },
                    { nis: '2024005', name: 'Doni Pratama', class: '8A' }
                ];
                
                for (const student of sampleStudents) {
                    await db.addStudent(student);
                }
            }
            
            // Add sample quiz if none exist
            if (appState.quizzes.length === 0) {
                const sampleQuiz = {
                    subject: 'Matematika',
                    class: '7A',
                    material: 'Aljabar Linear',
                    title: 'Quiz Aljabar Linear - Persamaan Dasar',
                    questions: [
                        {
                            question: 'Berapa hasil dari 2x + 3 = 11?',
                            options: ['x = 4', 'x = 5', 'x = 6', 'x = 7'],
                            correct: 0,
                            timeLimit: 30
                        },
                        {
                            question: 'Jika 3y - 5 = 10, maka nilai y adalah?',
                            options: ['y = 3', 'y = 4', 'y = 5', 'y = 6'],
                            correct: 2,
                            timeLimit: 30
                        },
                        {
                            question: 'Hasil dari 4a + 2a adalah?',
                            options: ['6a', '8a', '2a', '4a'],
                            correct: 0,
                            timeLimit: 25
                        }
                    ]
                };
                
                await db.addQuiz(sampleQuiz);
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972f3afea0adce65',t:'MTc1NTgzMjc4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
