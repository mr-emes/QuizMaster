<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizMaster Pro - Portal Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration - SUDAH DIKONFIGURASI ✅
        const firebaseConfig = {
            apiKey: "AIzaSyBY_QE1TeFyh0-zejlbEuHS3E3K0TquI4Y",
            authDomain: "quizmaster-pro-ff3a2.firebaseapp.com",
            databaseURL: "https://quizmaster-pro-ff3a2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "quizmaster-pro-ff3a2",
            storageBucket: "quizmaster-pro-ff3a2.firebasestorage.app",
            messagingSenderId: "290206514077",
            appId: "1:290206514077:web:aabfd60346f1bd9c6a4d74"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        console.log('🔥 Firebase initialized successfully');
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Nunito', sans-serif; }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .quiz-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quiz-option:hover {
            transform: translateX(5px);
            background-color: #f3f4f6;
        }
        
        .quiz-option.selected {
            background-color: #3b82f6;
            color: white;
            transform: translateX(5px);
        }
        
        .quiz-option.correct {
            background-color: #10b981;
            color: white;
        }
        
        .quiz-option.incorrect {
            background-color: #ef4444;
            color: white;
        }

        .timer-warning {
            animation: shake 0.5s ease-in-out infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exam-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .leaderboard-item {
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        .mode-live { background: linear-gradient(135deg, #10b981, #059669); }
        .mode-assignment { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .mode-exam { background: linear-gradient(135deg, #ef4444, #dc2626); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-indigo-700">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md slide-up">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">🎓</div>
                <h2 class="text-3xl font-bold text-gray-800">Portal Siswa</h2>
                <p class="text-gray-600 mt-2">QuizMaster Pro - Sistem Quiz Interaktif</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NIS (Nomor Induk Siswa)</label>
                    <input type="text" id="studentNIS" placeholder="Masukkan NIS Anda" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" onkeypress="if(event.key==='Enter') studentLogin()" oninput="debounceLoadStudentInfo()">
                </div>
                
                <!-- Student Info Display (Hidden by default) -->
                <div id="studentInfoDisplay" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="text-2xl">👤</div>
                        <div>
                            <div class="font-semibold text-blue-900" id="displayStudentName">-</div>
                            <div class="text-sm text-blue-700" id="displayStudentClass">-</div>
                            <div class="text-xs text-blue-600" id="displayStudentNIS">-</div>
                        </div>
                    </div>
                </div>
                
                <button onclick="studentLogin()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all">
                    🚀 Masuk Portal
                </button>
                
                <div class="text-center">
                    <div class="text-sm text-gray-500 mb-2">atau</div>
                    <button onclick="showJoinGameModal()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-green-700 hover:to-emerald-700 transition-all">
                        🎮 Join Game Langsung
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div id="joinGameModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Join Game</h3>
                <button onclick="hideJoinGameModal()" class="text-gray-500 hover:text-gray-700">✕</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kode Game</label>
                    <input type="text" id="gameCodeInput" placeholder="Masukkan kode game" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent text-center text-lg font-bold uppercase" maxlength="6">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">NIS</label>
                    <input type="text" id="quickNIS" placeholder="Masukkan NIS" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent" onblur="loadQuickStudentInfo()">
                </div>
                
                <!-- Quick Student Info Display -->
                <div id="quickStudentInfo" class="hidden bg-green-50 border border-green-200 rounded-xl p-3">
                    <div class="flex items-center space-x-2">
                        <div class="text-lg">👤</div>
                        <div>
                            <div class="font-medium text-green-900" id="quickDisplayName">-</div>
                            <div class="text-xs text-green-700" id="quickDisplayClass">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-4 pt-4">
                    <button onclick="hideJoinGameModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                        Batal
                    </button>
                    <button onclick="joinGameDirect()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-colors">
                        🎮 Join Game
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardScreen" class="min-h-screen bg-gray-50 hidden">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <h1 class="text-xl font-bold text-gray-900">🎯 QuizMaster Pro</h1>
                        <div class="hidden md:flex space-x-4">
                            <button onclick="showSection('dashboard')" class="nav-btn px-4 py-2 text-sm font-medium text-blue-600 bg-blue-50 rounded-lg">Dashboard</button>
                            <button onclick="showSection('assignments')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 rounded-lg">Tugas/PR</button>
                            <button onclick="showSection('exams')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 rounded-lg">Ujian</button>
                            <button onclick="showSection('history')" class="nav-btn px-4 py-2 text-sm font-medium text-gray-600 hover:text-blue-600 rounded-lg">Riwayat</button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" id="studentInfo">Siswa</span>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700">Keluar</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard Siswa</h2>
                <p class="text-gray-600">Selamat datang di portal quiz interaktif</p>
            </div>
            
            <!-- Join Game Card -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-8 text-white mb-8 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-2xl font-bold mb-2">🎮 Join Live Quiz</h3>
                        <p class="text-green-100 mb-4">Masukkan kode game untuk bergabung dengan quiz live</p>
                        <div class="flex items-center space-x-4">
                            <input type="text" id="dashboardGameCode" placeholder="Kode Game" class="px-4 py-2 rounded-lg text-gray-900 font-bold text-center uppercase" maxlength="6">
                            <button onclick="joinGameFromDashboard()" class="bg-white text-green-600 px-6 py-2 rounded-lg font-semibold hover:bg-green-50 transition-colors">
                                Join Game
                            </button>
                        </div>
                    </div>
                    <div class="text-6xl opacity-20">🎯</div>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">📝</div>
                        <div>
                            <p class="text-sm text-gray-600">Tugas Tersedia</p>
                            <p class="text-2xl font-bold text-gray-900" id="availableAssignments">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">🎯</div>
                        <div>
                            <p class="text-sm text-gray-600">Ujian Mendatang</p>
                            <p class="text-2xl font-bold text-gray-900" id="upcomingExams">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-sm card-hover">
                    <div class="flex items-center">
                        <div class="text-3xl mr-4">📊</div>
                        <div>
                            <p class="text-sm text-gray-600">Rata-rata Nilai</p>
                            <p class="text-2xl font-bold text-gray-900" id="averageScore">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activities -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                <div id="recentActivities" class="space-y-3">
                    <!-- Recent activities will be populated here -->
                </div>
            </div>
        </div>

        <!-- Assignments Section -->
        <div id="assignmentsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Tugas & PR</h2>
                <p class="text-gray-600">Daftar tugas yang perlu dikerjakan</p>
            </div>
            
            <div id="assignmentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Assignments will be populated here -->
            </div>
        </div>

        <!-- Exams Section -->
        <div id="examsSection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Ujian</h2>
                <p class="text-gray-600">Daftar ujian yang tersedia</p>
            </div>
            
            <div id="examsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Exams will be populated here -->
            </div>
        </div>

        <!-- History Section -->
        <div id="historySection" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Riwayat Quiz</h2>
                <p class="text-gray-600">Hasil quiz yang telah dikerjakan</p>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quiz</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mode</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nilai</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- History will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Game Screen -->
    <div id="gameScreen" class="min-h-screen bg-gray-900 text-white hidden">
        <!-- Game Header -->
        <div class="bg-gray-800 p-4">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div id="gameInfo" class="text-sm">
                        <div class="font-semibold" id="gameTitle">Quiz Title</div>
                        <div class="text-gray-400" id="gameSubject">Subject - Material</div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-6">
                    <div class="text-center">
                        <div class="text-xs text-gray-400">Soal</div>
                        <div class="font-bold" id="questionCounter">1/10</div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-xs text-gray-400">Skor</div>
                        <div class="font-bold text-green-400" id="currentScore">0</div>
                    </div>
                    
                    <div class="text-center" id="timerContainer">
                        <div class="text-xs text-gray-400">Waktu</div>
                        <div class="font-bold text-yellow-400" id="timer">30</div>
                    </div>
                    
                    <button onclick="exitGame()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm transition-colors">
                        Keluar
                    </button>
                </div>
            </div>
        </div>

        <!-- Waiting Room -->
        <div id="waitingRoom" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="text-6xl mb-6 pulse-animation">🎮</div>
                <h2 class="text-3xl font-bold mb-4">Menunggu Game Dimulai...</h2>
                <p class="text-gray-400 mb-6">Kode Game: <span class="font-bold text-2xl" id="displayGameCode"></span></p>
                <div class="bg-gray-800 rounded-xl p-6 max-w-md mx-auto">
                    <h3 class="font-semibold mb-4">Pemain yang Bergabung:</h3>
                    <div id="playersList" class="space-y-2">
                        <!-- Players will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="questionScreen" class="hidden">
            <div class="max-w-4xl mx-auto p-6">
                <!-- Progress Bar -->
                <div class="mb-6">
                    <div class="bg-gray-700 rounded-full h-2">
                        <div class="progress-bar bg-blue-500 h-2 rounded-full" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Question -->
                <div class="bg-gray-800 rounded-2xl p-8 mb-6">
                    <h2 class="text-2xl font-bold mb-6" id="questionText">Question will appear here</h2>
                    
                    <!-- Options -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="optionsContainer">
                        <!-- Options will be populated here -->
                    </div>
                </div>
                
                <!-- Navigation -->
                <div class="flex justify-between items-center">
                    <button id="prevButton" onclick="previousQuestion()" class="bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-xl transition-colors hidden">
                        ← Sebelumnya
                    </button>
                    
                    <div class="flex-1"></div>
                    
                    <button id="nextButton" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-xl transition-colors hidden">
                        Selanjutnya →
                    </button>
                    
                    <button id="submitButton" onclick="submitQuiz()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-xl transition-colors hidden">
                        Selesai
                    </button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div id="leaderboardScreen" class="hidden">
            <div class="max-w-4xl mx-auto p-6">
                <div class="text-center mb-8">
                    <h2 class="text-4xl font-bold mb-4">🏆 Leaderboard</h2>
                    <p class="text-gray-400">Hasil Quiz Live</p>
                </div>
                
                <div id="leaderboardList" class="space-y-4">
                    <!-- Leaderboard will be populated here -->
                </div>
                
                <div class="text-center mt-8">
                    <button onclick="exitGame()" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-xl transition-colors">
                        Kembali ke Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden">
            <div class="max-w-4xl mx-auto p-6">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4" id="resultEmoji">🎉</div>
                    <h2 class="text-4xl font-bold mb-4" id="resultTitle">Quiz Selesai!</h2>
                    <p class="text-gray-400 mb-6" id="resultSubtitle">Terima kasih telah mengerjakan quiz</p>
                    
                    <div class="bg-gray-800 rounded-2xl p-8 max-w-md mx-auto">
                        <div class="text-6xl font-bold text-green-400 mb-2" id="finalScore">85</div>
                        <div class="text-gray-400 mb-4">Nilai Akhir</div>
                        
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-green-400 font-bold" id="correctAnswers">8</div>
                                <div class="text-gray-400">Benar</div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-3">
                                <div class="text-red-400 font-bold" id="wrongAnswers">2</div>
                                <div class="text-gray-400">Salah</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="exitGame()" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-xl transition-colors">
                        Kembali ke Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Exam Warning Overlay -->
    <div id="examWarningOverlay" class="fullscreen-overlay hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-auto text-center">
            <div class="text-6xl mb-4">⚠️</div>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">Peringatan Ujian!</h3>
            <p class="text-gray-600 mb-6">Anda mencoba keluar dari mode ujian. Ini akan dicatat sebagai pelanggaran.</p>
            <div class="space-y-3">
                <button onclick="returnToExam()" class="w-full bg-green-600 text-white py-3 px-6 rounded-xl hover:bg-green-700 transition-colors">
                    Kembali ke Ujian
                </button>
                <button onclick="forceExitExam()" class="w-full bg-red-600 text-white py-3 px-6 rounded-xl hover:bg-red-700 transition-colors">
                    Keluar Paksa (Ujian Berakhir)
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            currentStudent: null,
            currentGame: null,
            currentQuiz: null,
            currentQuestion: 0,
            answers: [],
            score: 0,
            timeLeft: 0,
            timerInterval: null,
            gameMode: 'live',
            examWarnings: 0,
            examStartTime: null,
            isFullscreen: false,
            assignments: [],
            exams: [],
            history: []
        };

        // Sample student database for demo
        const sampleStudents = {
            '2024001': { name: 'Ahmad Fauzi', class: '7A', email: 'ahmad.fauzi@school.edu' },
            '2024002': { name: 'Siti Nurhaliza', class: '7A', email: 'siti.nurhaliza@school.edu' },
            '2024003': { name: 'Budi Santoso', class: '7B', email: 'budi.santoso@school.edu' },
            '2024004': { name: 'Dewi Sartika', class: '7B', email: 'dewi.sartika@school.edu' },
            '2024005': { name: 'Rizki Pratama', class: '8A', email: 'rizki.pratama@school.edu' },
            '2024006': { name: 'Maya Indira', class: '8A', email: 'maya.indira@school.edu' },
            '2024007': { name: 'Andi Wijaya', class: '8B', email: 'andi.wijaya@school.edu' },
            '2024008': { name: 'Putri Maharani', class: '8B', email: 'putri.maharani@school.edu' },
            '2024009': { name: 'Fajar Nugroho', class: '9A', email: 'fajar.nugroho@school.edu' },
            '2024010': { name: 'Indah Permata', class: '9A', email: 'indah.permata@school.edu' }
        };

        // Firebase Database wrapper
        const db = {
            async init() {
                try {
                    console.log('🔥 Initializing Firebase connection...');
                    return true;
                } catch (error) {
                    console.error('❌ Firebase connection failed:', error);
                    console.log('📱 Using offline mode');
                    return false;
                }
            },
            
            async getStudent(nis) {
                try {
                    // First check sample database
                    if (sampleStudents[nis]) {
                        return {
                            nis: nis,
                            ...sampleStudents[nis]
                        };
                    }
                    
                    // Then try Firebase
                    const snapshot = await database.ref(`students/${nis}`).once('value');
                    if (snapshot.exists()) {
                        return {
                            nis: nis,
                            ...snapshot.val()
                        };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting student:', error);
                    // Check sample database as fallback
                    if (sampleStudents[nis]) {
                        return {
                            nis: nis,
                            ...sampleStudents[nis]
                        };
                    }
                    return null;
                }
            },
            
            async getGame(gameCode) {
                try {
                    const snapshot = await database.ref(`games/${gameCode}`).once('value');
                    if (snapshot.exists()) {
                        return {
                            gameCode: gameCode,
                            ...snapshot.val()
                        };
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting game:', error);
                    return null;
                }
            },
            
            async joinGame(gameCode, student) {
                try {
                    const gameRef = database.ref(`games/${gameCode}`);
                    const snapshot = await gameRef.once('value');
                    
                    if (snapshot.exists()) {
                        const gameData = snapshot.val();
                        const players = gameData.players || [];
                        
                        // Check if student already joined
                        const existingPlayer = players.find(p => p.nis === student.nis);
                        if (!existingPlayer) {
                            players.push({
                                nis: student.nis,
                                name: student.name,
                                class: student.class,
                                joinedAt: Date.now(),
                                score: 0
                            });
                            
                            await database.ref(`games/${gameCode}`).update({
                                players: players
                            });
                        }
                        
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Error joining game:', error);
                    return true; // Allow offline mode
                }
            },
            
            async submitAnswer(gameCode, nis, questionIndex, answer, timeSpent) {
                try {
                    await database.ref(`answers/${gameCode}/${nis}/${questionIndex}`).set({
                        answer: answer,
                        timeSpent: timeSpent,
                        timestamp: Date.now()
                    });
                    return true;
                } catch (error) {
                    console.error('Error submitting answer:', error);
                    return true; // Allow offline mode
                }
            },
            
            async submitFinalScore(gameCode, nis, score, answers, completedAt) {
                try {
                    await database.ref(`grades/${gameCode}/${nis}`).set({
                        score: score,
                        answers: answers,
                        completedAt: completedAt,
                        nis: nis
                    });
                    return true;
                } catch (error) {
                    console.error('Error submitting final score:', error);
                    return true; // Allow offline mode
                }
            },
            
            async getAssignments(studentClass) {
                try {
                    const snapshot = await database.ref('games').once('value');
                    const assignments = [];
                    
                    if (snapshot.exists()) {
                        const games = snapshot.val();
                        Object.keys(games).forEach(gameCode => {
                            const game = games[gameCode];
                            if (game.mode === 'assignment' && 
                                game.class === studentClass && 
                                !game.completed) {
                                assignments.push({
                                    gameCode: gameCode,
                                    ...game
                                });
                            }
                        });
                    }
                    
                    return assignments;
                } catch (error) {
                    console.error('Error getting assignments:', error);
                    return [];
                }
            },
            
            async getExams(studentClass) {
                try {
                    const snapshot = await database.ref('games').once('value');
                    const exams = [];
                    
                    if (snapshot.exists()) {
                        const games = snapshot.val();
                        Object.keys(games).forEach(gameCode => {
                            const game = games[gameCode];
                            if (game.mode === 'exam' && 
                                game.class === studentClass && 
                                !game.completed) {
                                exams.push({
                                    gameCode: gameCode,
                                    ...game
                                });
                            }
                        });
                    }
                    
                    return exams;
                } catch (error) {
                    console.error('Error getting exams:', error);
                    return [];
                }
            },
            
            async getStudentHistory(nis) {
                try {
                    const snapshot = await database.ref('grades').once('value');
                    const history = [];
                    
                    if (snapshot.exists()) {
                        const grades = snapshot.val();
                        Object.keys(grades).forEach(gameCode => {
                            if (grades[gameCode][nis]) {
                                history.push({
                                    gameCode: gameCode,
                                    ...grades[gameCode][nis]
                                });
                            }
                        });
                    }
                    
                    return history.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
                } catch (error) {
                    console.error('Error getting student history:', error);
                    return [];
                }
            }
        };

        // Authentication
        async function studentLogin() {
            const nis = document.getElementById('studentNIS').value.trim();
            
            if (!nis) {
                Swal.fire({
                    icon: 'warning',
                    title: 'NIS Kosong!',
                    text: 'Mohon masukkan NIS Anda.',
                    confirmButtonColor: '#3b82f6'
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Memverifikasi NIS...',
                    text: 'Mohon tunggu sebentar.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                await db.init();
                const student = await db.getStudent(nis);
                
                if (student) {
                    appState.currentStudent = student;
                    showDashboard();
                    Swal.close();
                    
                    // Show welcome message
                    Swal.fire({
                        icon: 'success',
                        title: `Selamat Datang, ${student.name}!`,
                        text: `Kelas: ${student.class}`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'NIS Tidak Ditemukan!',
                        text: 'NIS yang Anda masukkan tidak terdaftar dalam sistem.',
                        confirmButtonColor: '#ef4444'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Login Gagal!',
                    text: 'Terjadi kesalahan saat login. Silakan coba lagi.',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        // Auto-load student info when NIS is entered
        async function loadStudentInfo() {
            const nis = document.getElementById('studentNIS').value.trim();
            const infoDisplay = document.getElementById('studentInfoDisplay');
            
            if (!nis) {
                infoDisplay.classList.add('hidden');
                return;
            }
            
            try {
                const student = await db.getStudent(nis);
                if (student) {
                    document.getElementById('displayStudentName').textContent = student.name;
                    document.getElementById('displayStudentClass').textContent = `Kelas: ${student.class}`;
                    document.getElementById('displayStudentNIS').textContent = `NIS: ${student.nis}`;
                    infoDisplay.classList.remove('hidden');
                } else {
                    infoDisplay.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading student info:', error);
                infoDisplay.classList.add('hidden');
            }
        }

        // Quick join student info loader
        async function loadQuickStudentInfo() {
            const nis = document.getElementById('quickNIS').value.trim();
            const infoDisplay = document.getElementById('quickStudentInfo');
            
            if (!nis) {
                infoDisplay.classList.add('hidden');
                return;
            }
            
            try {
                const student = await db.getStudent(nis);
                if (student) {
                    document.getElementById('quickDisplayName').textContent = student.name;
                    document.getElementById('quickDisplayClass').textContent = `Kelas: ${student.class}`;
                    infoDisplay.classList.remove('hidden');
                } else {
                    infoDisplay.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading quick student info:', error);
                infoDisplay.classList.add('hidden');
            }
        }

        function logout() {
            Swal.fire({
                title: 'Konfirmasi Logout',
                text: 'Yakin ingin keluar dari portal?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    appState.currentStudent = null;
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('dashboardScreen').classList.add('hidden');
                    document.getElementById('gameScreen').classList.add('hidden');
                }
            });
        }

        // Navigation
        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            
            document.getElementById('studentInfo').textContent = `${appState.currentStudent.name} - ${appState.currentStudent.class}`;
            showSection('dashboard');
            loadDashboardData();
        }

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('[id$="Section"]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'bg-blue-50');
                btn.classList.add('text-gray-600');
            });
            
            if (event && event.target) {
                event.target.classList.remove('text-gray-600');
                event.target.classList.add('text-blue-600', 'bg-blue-50');
            }
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'assignments':
                    loadAssignments();
                    break;
                case 'exams':
                    loadExams();
                    break;
                case 'history':
                    loadHistory();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            if (!appState.currentStudent) return;
            
            try {
                // Load assignments
                const assignments = await db.getAssignments(appState.currentStudent.class);
                appState.assignments = assignments;
                document.getElementById('availableAssignments').textContent = assignments.length;
                
                // Load exams
                const exams = await db.getExams(appState.currentStudent.class);
                appState.exams = exams;
                document.getElementById('upcomingExams').textContent = exams.length;
                
                // Load history and calculate average
                const history = await db.getStudentHistory(appState.currentStudent.nis);
                appState.history = history;
                
                if (history.length > 0) {
                    const average = history.reduce((sum, item) => sum + item.score, 0) / history.length;
                    document.getElementById('averageScore').textContent = Math.round(average);
                } else {
                    document.getElementById('averageScore').textContent = '0';
                }
                
                // Load recent activities
                loadRecentActivities();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function loadRecentActivities() {
            const container = document.getElementById('recentActivities');
            container.innerHTML = '';
            
            if (appState.history.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Belum ada aktivitas</p>';
                return;
            }
            
            const recentActivities = appState.history.slice(0, 5);
            recentActivities.forEach(activity => {
                const activityDiv = document.createElement('div');
                activityDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                
                const scoreClass = activity.score >= 80 ? 'text-green-600' : activity.score >= 60 ? 'text-yellow-600' : 'text-red-600';
                
                activityDiv.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">Quiz Selesai</div>
                        <div class="text-xs text-gray-500">${new Date(activity.completedAt).toLocaleDateString('id-ID')}</div>
                    </div>
                    <div class="text-sm font-bold ${scoreClass}">${activity.score}</div>
                `;
                container.appendChild(activityDiv);
            });
        }

        // Join Game functions
        function showJoinGameModal() {
            document.getElementById('joinGameModal').classList.remove('hidden');
        }

        function hideJoinGameModal() {
            document.getElementById('joinGameModal').classList.add('hidden');
            document.getElementById('gameCodeInput').value = '';
            document.getElementById('quickNIS').value = '';
            document.getElementById('quickName').value = '';
        }

        async function joinGameDirect() {
            const gameCode = document.getElementById('gameCodeInput').value.trim().toUpperCase();
            const nis = document.getElementById('quickNIS').value.trim();
            
            if (!gameCode || !nis) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Data Tidak Lengkap!',
                    text: 'Mohon masukkan kode game dan NIS.',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }
            
            // Get student data from NIS
            const student = await db.getStudent(nis);
            if (!student) {
                Swal.fire({
                    icon: 'error',
                    title: 'NIS Tidak Ditemukan!',
                    text: 'NIS yang Anda masukkan tidak terdaftar dalam sistem.',
                    confirmButtonColor: '#ef4444'
                });
                return;
            }
            
            appState.currentStudent = student;
            await joinGame(gameCode);
            hideJoinGameModal();
        }

        async function joinGameFromDashboard() {
            const gameCode = document.getElementById('dashboardGameCode').value.trim().toUpperCase();
            
            if (!gameCode) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Kode Game Kosong!',
                    text: 'Mohon masukkan kode game.',
                    confirmButtonColor: '#f59e0b'
                });
                return;
            }
            
            await joinGame(gameCode);
            document.getElementById('dashboardGameCode').value = '';
        }

        async function joinGame(gameCode) {
            if (!appState.currentStudent) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Data siswa tidak ditemukan.',
                    confirmButtonColor: '#ef4444'
                });
                return;
            }
            
            try {
                Swal.fire({
                    title: 'Bergabung ke Game...',
                    text: 'Mohon tunggu sebentar.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                const game = await db.getGame(gameCode);
                
                if (!game) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Game Tidak Ditemukan!',
                        text: 'Kode game tidak valid atau game sudah berakhir.',
                        confirmButtonColor: '#ef4444'
                    });
                    return;
                }
                
                // Check if student's class matches
                if (game.class !== appState.currentStudent.class && game.class !== 'All') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Kelas Tidak Sesuai!',
                        text: `Game ini khusus untuk kelas ${game.class}.`,
                        confirmButtonColor: '#f59e0b'
                    });
                    return;
                }
                
                const joined = await db.joinGame(gameCode, appState.currentStudent);
                
                if (joined) {
                    appState.currentGame = game;
                    appState.currentQuiz = game.quiz;
                    appState.gameMode = game.mode;
                    
                    Swal.close();
                    startGame();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal Bergabung!',
                        text: 'Tidak dapat bergabung ke game.',
                        confirmButtonColor: '#ef4444'
                    });
                }
                
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: 'Terjadi kesalahan saat bergabung ke game.',
                    confirmButtonColor: '#ef4444'
                });
                console.error('Error joining game:', error);
            }
        }

        // Game functions
        function startGame() {
            document.getElementById('dashboardScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // Setup game info
            document.getElementById('gameTitle').textContent = appState.currentQuiz.title;
            document.getElementById('gameSubject').textContent = `${appState.currentQuiz.subject} - ${appState.currentQuiz.material}`;
            document.getElementById('displayGameCode').textContent = appState.currentGame.gameCode;
            
            // Initialize game state
            appState.currentQuestion = 0;
            appState.answers = [];
            appState.score = 0;
            appState.examWarnings = 0;
            
            // Setup mode-specific features
            if (appState.gameMode === 'exam') {
                setupExamMode();
            }
            
            // Show waiting room for live games, start directly for others
            if (appState.gameMode === 'live') {
                showWaitingRoom();
            } else {
                startQuiz();
            }
        }

        function showWaitingRoom() {
            document.getElementById('waitingRoom').classList.remove('hidden');
            document.getElementById('questionScreen').classList.add('hidden');
            
            // Simulate players joining (in real app, this would be real-time)
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = `
                <div class="text-sm text-gray-400">👤 ${appState.currentStudent.name}</div>
                <div class="text-sm text-gray-400">👤 Ahmad Fauzi</div>
                <div class="text-sm text-gray-400">👤 Siti Nurhaliza</div>
            `;
            
            // Auto start after 3 seconds (in real app, admin would start)
            setTimeout(() => {
                startQuiz();
            }, 3000);
        }

        function startQuiz() {
            document.getElementById('waitingRoom').classList.add('hidden');
            document.getElementById('questionScreen').classList.remove('hidden');
            
            // Setup question counter
            const totalQuestions = appState.currentQuiz.questions.length;
            document.getElementById('questionCounter').textContent = `1/${totalQuestions}`;
            
            // Initialize answers array
            appState.answers = new Array(totalQuestions).fill(null);
            
            // Show first question
            showQuestion(0);
        }

        function showQuestion(index) {
            const question = appState.currentQuiz.questions[index];
            if (!question) return;
            
            appState.currentQuestion = index;
            
            // Update progress bar
            const progress = ((index + 1) / appState.currentQuiz.questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            // Update question counter
            document.getElementById('questionCounter').textContent = `${index + 1}/${appState.currentQuiz.questions.length}`;
            
            // Show question text
            document.getElementById('questionText').textContent = question.question;
            
            // Show options
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, optionIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = `quiz-option p-4 border-2 border-gray-600 rounded-xl ${appState.answers[index] === optionIndex ? 'selected' : ''}`;
                optionDiv.onclick = () => selectOption(optionIndex);
                optionDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full border-2 border-current flex items-center justify-center font-bold">
                            ${String.fromCharCode(65 + optionIndex)}
                        </div>
                        <div class="flex-1">${option}</div>
                    </div>
                `;
                optionsContainer.appendChild(optionDiv);
            });
            
            // Setup timer
            if (appState.gameMode === 'live') {
                startTimer(question.timeLimit || 30);
            } else {
                document.getElementById('timerContainer').classList.add('hidden');
            }
            
            // Update navigation buttons
            updateNavigationButtons();
        }

        function selectOption(optionIndex) {
            // Clear previous selection
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Select new option
            event.currentTarget.classList.add('selected');
            
            // Save answer
            appState.answers[appState.currentQuestion] = optionIndex;
            
            // Auto advance for live mode
            if (appState.gameMode === 'live') {
                setTimeout(() => {
                    nextQuestion();
                }, 1000);
            } else {
                updateNavigationButtons();
            }
        }

        function startTimer(seconds) {
            appState.timeLeft = seconds;
            document.getElementById('timer').textContent = seconds;
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            appState.timerInterval = setInterval(() => {
                appState.timeLeft--;
                document.getElementById('timer').textContent = appState.timeLeft;
                
                // Warning when time is low
                if (appState.timeLeft <= 5) {
                    document.getElementById('timer').classList.add('timer-warning');
                } else {
                    document.getElementById('timer').classList.remove('timer-warning');
                }
                
                // Time's up
                if (appState.timeLeft <= 0) {
                    clearInterval(appState.timerInterval);
                    nextQuestion();
                }
            }, 1000);
        }

        function updateNavigationButtons() {
            const totalQuestions = appState.currentQuiz.questions.length;
            const isLastQuestion = appState.currentQuestion === totalQuestions - 1;
            const isFirstQuestion = appState.currentQuestion === 0;
            
            // Show/hide navigation buttons based on mode
            if (appState.gameMode === 'live') {
                // Live mode: no navigation buttons (auto advance)
                document.getElementById('prevButton').classList.add('hidden');
                document.getElementById('nextButton').classList.add('hidden');
                document.getElementById('submitButton').classList.add('hidden');
            } else {
                // Assignment/Exam mode: show navigation
                document.getElementById('prevButton').classList.toggle('hidden', isFirstQuestion || appState.gameMode === 'exam');
                document.getElementById('nextButton').classList.toggle('hidden', isLastQuestion);
                document.getElementById('submitButton').classList.toggle('hidden', !isLastQuestion);
            }
        }

        function previousQuestion() {
            if (appState.currentQuestion > 0 && appState.gameMode !== 'exam') {
                showQuestion(appState.currentQuestion - 1);
            }
        }

        function nextQuestion() {
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            const totalQuestions = appState.currentQuiz.questions.length;
            
            if (appState.currentQuestion < totalQuestions - 1) {
                showQuestion(appState.currentQuestion + 1);
            } else {
                // Quiz completed
                submitQuiz();
            }
        }

        async function submitQuiz() {
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            // Calculate score
            let correctAnswers = 0;
            appState.currentQuiz.questions.forEach((question, index) => {
                if (appState.answers[index] === question.correct) {
                    correctAnswers++;
                }
            });
            
            appState.score = Math.round((correctAnswers / appState.currentQuiz.questions.length) * 100);
            
            // Submit to database
            try {
                await db.submitFinalScore(
                    appState.currentGame.gameCode,
                    appState.currentStudent.nis,
                    appState.score,
                    appState.answers,
                    new Date().toISOString()
                );
            } catch (error) {
                console.error('Error submitting score:', error);
            }
            
            // Show results
            if (appState.gameMode === 'live') {
                showLeaderboard();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            const correctAnswers = appState.answers.filter((answer, index) => 
                answer === appState.currentQuiz.questions[index].correct
            ).length;
            
            const wrongAnswers = appState.currentQuiz.questions.length - correctAnswers;
            
            // Update result display
            document.getElementById('finalScore').textContent = appState.score;
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('wrongAnswers').textContent = wrongAnswers;
            
            // Set emoji and title based on score
            if (appState.score >= 90) {
                document.getElementById('resultEmoji').textContent = '🏆';
                document.getElementById('resultTitle').textContent = 'Luar Biasa!';
                document.getElementById('resultSubtitle').textContent = 'Nilai sempurna! Pertahankan prestasi ini.';
            } else if (appState.score >= 80) {
                document.getElementById('resultEmoji').textContent = '🎉';
                document.getElementById('resultTitle').textContent = 'Bagus Sekali!';
                document.getElementById('resultSubtitle').textContent = 'Hasil yang memuaskan. Terus tingkatkan!';
            } else if (appState.score >= 60) {
                document.getElementById('resultEmoji').textContent = '👍';
                document.getElementById('resultTitle').textContent = 'Cukup Baik!';
                document.getElementById('resultSubtitle').textContent = 'Masih bisa ditingkatkan lagi.';
            } else {
                document.getElementById('resultEmoji').textContent = '💪';
                document.getElementById('resultTitle').textContent = 'Tetap Semangat!';
                document.getElementById('resultSubtitle').textContent = 'Belajar lagi dan coba lagi ya!';
            }
        }

        function showLeaderboard() {
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('leaderboardScreen').classList.remove('hidden');
            
            // Simulate leaderboard data (in real app, this would be real-time)
            const leaderboardData = [
                { name: appState.currentStudent.name, score: appState.score, nis: appState.currentStudent.nis },
                { name: 'Ahmad Fauzi', score: 95, nis: '2024001' },
                { name: 'Siti Nurhaliza', score: 88, nis: '2024002' },
                { name: 'Budi Santoso', score: 82, nis: '2024003' }
            ].sort((a, b) => b.score - a.score);
            
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            leaderboardData.forEach((player, index) => {
                const isCurrentStudent = player.nis === appState.currentStudent.nis;
                const rankEmoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅';
                
                const playerDiv = document.createElement('div');
                playerDiv.className = `leaderboard-item flex items-center justify-between p-4 rounded-xl ${isCurrentStudent ? 'bg-blue-600' : 'bg-gray-800'}`;
                playerDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="text-2xl">${rankEmoji}</div>
                        <div>
                            <div class="font-semibold">${player.name} ${isCurrentStudent ? '(Anda)' : ''}</div>
                            <div class="text-sm opacity-75">Peringkat ${index + 1}</div>
                        </div>
                    </div>
                    <div class="text-2xl font-bold">${player.score}</div>
                `;
                leaderboardList.appendChild(playerDiv);
            });
        }

        function exitGame() {
            if (appState.gameMode === 'exam' && document.getElementById('questionScreen').classList.contains('hidden') === false) {
                showExamWarning();
                return;
            }
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
            }
            
            // Reset game state
            appState.currentGame = null;
            appState.currentQuiz = null;
            appState.currentQuestion = 0;
            appState.answers = [];
            appState.score = 0;
            appState.examWarnings = 0;
            
            // Return to dashboard
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
            
            // Refresh dashboard data
            loadDashboardData();
        }

        // Exam Mode Functions
        function setupExamMode() {
            appState.examStartTime = Date.now();
            
            // Request fullscreen
            if (appState.currentQuiz.settings?.fullscreen) {
                requestFullscreen();
            }
            
            // Setup tab/window change detection
            if (appState.currentQuiz.settings?.blockTabs) {
                setupTabChangeDetection();
            }
            
            // Setup exam timer
            if (appState.currentQuiz.settings?.duration) {
                setupExamTimer(appState.currentQuiz.settings.duration * 60); // Convert to seconds
            }
        }

        function requestFullscreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
            
            appState.isFullscreen = true;
        }

        function setupTabChangeDetection() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);
            window.addEventListener('beforeunload', handleBeforeUnload);
        }

        function handleVisibilityChange() {
            if (document.hidden && appState.gameMode === 'exam') {
                recordExamViolation('Tab/Window changed');
            }
        }

        function handleWindowBlur() {
            if (appState.gameMode === 'exam') {
                recordExamViolation('Window lost focus');
            }
        }

        function handleBeforeUnload(e) {
            if (appState.gameMode === 'exam') {
                e.preventDefault();
                e.returnValue = 'Ujian sedang berlangsung. Yakin ingin keluar?';
                return e.returnValue;
            }
        }

        function recordExamViolation(type) {
            appState.examWarnings++;
            
            // Show warning
            showExamViolationWarning(type);
            
            // Auto-submit if too many violations
            const warningLimit = appState.currentQuiz.settings?.warningLimit || 3;
            if (appState.examWarnings >= warningLimit) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ujian Berakhir!',
                    text: `Terlalu banyak pelanggaran (${appState.examWarnings}). Ujian akan berakhir otomatis.`,
                    confirmButtonColor: '#ef4444',
                    allowOutsideClick: false
                }).then(() => {
                    submitQuiz();
                });
            }
        }

        function showExamViolationWarning(type) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'exam-warning';
            warningDiv.innerHTML = `
                <div class="font-semibold">⚠️ Pelanggaran Ujian!</div>
                <div class="text-sm">${type} - Peringatan ${appState.examWarnings}</div>
            `;
            
            document.body.appendChild(warningDiv);
            
            setTimeout(() => {
                warningDiv.remove();
            }, 5000);
        }

        function setupExamTimer(totalSeconds) {
            let timeLeft = totalSeconds;
            
            const timerDisplay = document.getElementById('timer');
            timerDisplay.textContent = formatTime(timeLeft);
            
            const examTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = formatTime(timeLeft);
                
                // Warning when 5 minutes left
                if (timeLeft <= 300) {
                    timerDisplay.classList.add('timer-warning');
                }
                
                // Auto submit when time's up
                if (timeLeft <= 0) {
                    clearInterval(examTimer);
                    Swal.fire({
                        icon: 'info',
                        title: 'Waktu Habis!',
                        text: 'Waktu ujian telah berakhir. Jawaban akan dikumpulkan otomatis.',
                        confirmButtonColor: '#3b82f6',
                        allowOutsideClick: false
                    }).then(() => {
                        submitQuiz();
                    });
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function showExamWarning() {
            document.getElementById('examWarningOverlay').classList.remove('hidden');
        }

        function returnToExam() {
            document.getElementById('examWarningOverlay').classList.add('hidden');
        }

        function forceExitExam() {
            recordExamViolation('Force exit');
            submitQuiz();
            document.getElementById('examWarningOverlay').classList.add('hidden');
        }

        // Assignment and Exam Loading
        async function loadAssignments() {
            if (!appState.currentStudent) return;
            
            const assignments = await db.getAssignments(appState.currentStudent.class);
            appState.assignments = assignments;
            
            const container = document.getElementById('assignmentsList');
            container.innerHTML = '';
            
            if (assignments.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Tidak ada tugas tersedia</div>';
                return;
            }
            
            assignments.forEach(assignment => {
                const deadline = new Date(assignment.settings?.deadline);
                const isExpired = deadline < new Date();
                
                const assignmentCard = document.createElement('div');
                assignmentCard.className = 'bg-white rounded-xl shadow-sm overflow-hidden card-hover';
                assignmentCard.innerHTML = `
                    <div class="mode-assignment p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">📝</span>
                                <span class="font-semibold">Tugas/PR</span>
                            </div>
                            <span class="text-sm opacity-75">${assignment.quiz?.questions?.length || 0} soal</span>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${assignment.quiz?.title || 'Tugas'}</h3>
                        <div class="space-y-1 text-sm text-gray-600 mb-4">
                            <div>📚 ${assignment.subject}</div>
                            <div>🎯 ${assignment.material}</div>
                            <div>⏰ Deadline: ${deadline.toLocaleDateString('id-ID')} ${deadline.toLocaleTimeString('id-ID', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div>⏱️ Durasi: ${assignment.settings?.duration || 60} menit</div>
                        </div>
                        
                        ${isExpired ? 
                            '<div class="bg-red-100 text-red-800 px-3 py-2 rounded-lg text-sm">Sudah melewati deadline</div>' :
                            `<button onclick="startAssignment('${assignment.gameCode}')" class="w-full bg-orange-600 text-white py-2 px-4 rounded-lg hover:bg-orange-700 transition-colors">
                                🚀 Mulai Mengerjakan
                            </button>`
                        }
                    </div>
                `;
                container.appendChild(assignmentCard);
            });
        }

        async function loadExams() {
            if (!appState.currentStudent) return;
            
            const exams = await db.getExams(appState.currentStudent.class);
            appState.exams = exams;
            
            const container = document.getElementById('examsList');
            container.innerHTML = '';
            
            if (exams.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">Tidak ada ujian tersedia</div>';
                return;
            }
            
            exams.forEach(exam => {
                const examCard = document.createElement('div');
                examCard.className = 'bg-white rounded-xl shadow-sm overflow-hidden card-hover';
                examCard.innerHTML = `
                    <div class="mode-exam p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">🎯</span>
                                <span class="font-semibold">Ujian</span>
                            </div>
                            <span class="text-sm opacity-75">${exam.quiz?.questions?.length || 0} soal</span>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">${exam.quiz?.title || 'Ujian'}</h3>
                        <div class="space-y-1 text-sm text-gray-600 mb-4">
                            <div>📚 ${exam.subject}</div>
                            <div>🎯 ${exam.material}</div>
                            <div>⏱️ Durasi: ${exam.settings?.duration || 90} menit</div>
                            <div>🔒 Mode Ketat: ${exam.settings?.blockTabs ? 'Ya' : 'Tidak'}</div>
                            <div>📺 Fullscreen: ${exam.settings?.fullscreen ? 'Wajib' : 'Tidak'}</div>
                        </div>
                        
                        <button onclick="startExam('${exam.gameCode}')" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                            🎯 Mulai Ujian
                        </button>
                    </div>
                `;
                container.appendChild(examCard);
            });
        }

        async function startAssignment(gameCode) {
            const assignment = appState.assignments.find(a => a.gameCode === gameCode);
            if (!assignment) return;
            
            const result = await Swal.fire({
                title: 'Mulai Tugas/PR?',
                html: `
                    <div class="text-left">
                        <p class="mb-2"><strong>Judul:</strong> ${assignment.quiz?.title}</p>
                        <p class="mb-2"><strong>Durasi:</strong> ${assignment.settings?.duration || 60} menit</p>
                        <p class="mb-2"><strong>Jumlah Soal:</strong> ${assignment.quiz?.questions?.length || 0}</p>
                        <p class="mb-4"><strong>Deadline:</strong> ${new Date(assignment.settings?.deadline).toLocaleString('id-ID')}</p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-sm text-yellow-800">⚠️ Setelah dimulai, waktu akan terus berjalan sampai selesai atau habis.</p>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f59e0b',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Mulai',
                cancelButtonText: 'Batal'
            });
            
            if (result.isConfirmed) {
                appState.currentGame = assignment;
                appState.currentQuiz = assignment.quiz;
                appState.gameMode = 'assignment';
                startGame();
            }
        }

        async function startExam(gameCode) {
            const exam = appState.exams.find(e => e.gameCode === gameCode);
            if (!exam) return;
            
            const result = await Swal.fire({
                title: 'Mulai Ujian?',
                html: `
                    <div class="text-left">
                        <p class="mb-2"><strong>Judul:</strong> ${exam.quiz?.title}</p>
                        <p class="mb-2"><strong>Durasi:</strong> ${exam.settings?.duration || 90} menit</p>
                        <p class="mb-2"><strong>Jumlah Soal:</strong> ${exam.quiz?.questions?.length || 0}</p>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <p class="text-sm text-red-800 font-semibold mb-2">⚠️ PERHATIAN UJIAN:</p>
                            <ul class="text-xs text-red-700 space-y-1">
                                ${exam.settings?.fullscreen ? '<li>• Akan masuk mode fullscreen</li>' : ''}
                                ${exam.settings?.blockTabs ? '<li>• Tidak boleh berpindah tab/aplikasi</li>' : ''}
                                <li>• Pelanggaran akan dicatat sistem</li>
                                <li>• Ujian berakhir otomatis jika terlalu banyak pelanggaran</li>
                                <li>• Tidak bisa kembali ke soal sebelumnya</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600">Pastikan koneksi internet stabil dan tidak ada gangguan.</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Mulai Ujian',
                cancelButtonText: 'Batal'
            });
            
            if (result.isConfirmed) {
                appState.currentGame = exam;
                appState.currentQuiz = exam.quiz;
                appState.gameMode = 'exam';
                startGame();
            }
        }

        async function loadHistory() {
            if (!appState.currentStudent) return;
            
            const history = await db.getStudentHistory(appState.currentStudent.nis);
            appState.history = history;
            
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Belum ada riwayat quiz</td></tr>';
                return;
            }
            
            history.forEach(item => {
                const modeText = item.mode === 'live' ? 'Live' : item.mode === 'assignment' ? 'Tugas' : 'Ujian';
                const modeClass = item.mode === 'live' ? 'bg-green-100 text-green-800' : item.mode === 'assignment' ? 'bg-orange-100 text-orange-800' : 'bg-red-100 text-red-800';
                const scoreClass = item.score >= 80 ? 'text-green-600' : item.score >= 60 ? 'text-yellow-600' : 'text-red-600';
                const statusClass = item.score >= 60 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = item.score >= 60 ? 'Lulus' : 'Tidak Lulus';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(item.completedAt).toLocaleDateString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Quiz ${item.gameCode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">-</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs ${modeClass}">${modeText}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${scoreClass}">${item.score}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs ${statusClass}">${statusText}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Auto-uppercase game code input
        document.addEventListener('DOMContentLoaded', function() {
            const gameCodeInputs = ['gameCodeInput', 'dashboardGameCode'];
            gameCodeInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        this.value = this.value.toUpperCase();
                    });
                }
            });
        });

        // Debounce function for auto-lookup
        let studentLookupTimeout;
        function debounceLoadStudentInfo() {
            clearTimeout(studentLookupTimeout);
            studentLookupTimeout = setTimeout(loadStudentInfo, 500);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            db.init();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972f7090c2fdf918',t:'MTc1NTgzNDk4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
